ç¾çŠ¶ã®æ§‹é€ ã‚’ã–ã£ãã‚ŠæŒ¯ã‚Šè¿”ã‚‹ã¨ï¼š
æˆ¦é—˜ä¸­ã®çŠ¶æ…‹ã‚’æŒã¤ã®ã¯ BattleActorState
ã€€HPã€çŠ¶æ…‹ç•°å¸¸ã®ã‚»ãƒƒãƒˆã€reflect_chargesï¼ˆReflectæ®‹å›æ•°ï¼‰ãªã©ã‚’æŒã£ã¦ã„ã‚‹ã€‚
ã‚­ãƒ£ãƒ©å´ã®æœ€çµ‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼šFinalCharacterStats 
æ•µå´ã®æœ€çµ‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼šFinalEnemyStats 
å±æ€§ç›¸æ€§é–¢ä¿‚
ã€€ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã«å¯¾ã—ã¦ï¼šelement_relation_and_hits_for_monster 
ã€€ã‚­ãƒ£ãƒ©ã«å¯¾ã—ã¦ï¼šelement_relation_and_hits_on_char 
çŠ¶æ…‹ç•°å¸¸é­”æ³•ï¼ˆã‚­ãƒ£ãƒ©â†’æ•µï¼‰ã¯ apply_status_spell_to_enemy ã§ã¾ã¨ã‚ã¦ã„ã‚‹ã€‚


--------------
ãã†ãªã‚“ã§ã™ã‚ˆã­ã€ã€Œæ•µã«ã‚‚ Agility ãŒã‚ã‚‹å‰æã€ã§è©±ã—ã¦ã—ã¾ã†ã¨ã€
ã„ã– JSON ã‚’è¦‹ã‚‹ã¨ **Agility ãŒç„¡ã„** ã¨ã„ã†å•é¡ŒãŒå‡ºã¦ãã¾ã™ ğŸ¥²

ã§ã‚‚å¤§ä¸ˆå¤«ã§ã€ã‚„ã‚Šæ–¹ã¯ã„ãã¤ã‹ã‚ã‚Šã¾ã™ã€‚

---
## æ–¹é‡ï¼šæ•µç”¨ã®ã€Œæ“¬ä¼¼ Agilityã€ã‚’å®šç¾©ã—ã¦ã—ã¾ã†
**çµè«–ã‹ã‚‰è¨€ã†ã¨ï¼š**
> ã€Œæ•µã‚‚å‘³æ–¹ã‚‚ã¾ã¨ã‚ã¦è¡Œå‹•é †ã‚’æ±ºã‚ãŸã„ã€
> â†’ æ•µã«ã¯ **JSON ã‹ã‚‰è¨ˆç®—ã—ãŸ â€œä»®ã®ç´ æ—©ã•â€** ã‚’æŒãŸã›ã¦ã—ã¾ã†
ã®ãŒä¸€ç•ªãã‚Œã„ã§ã™ã€‚

### ã©ã“ã«æŒãŸã›ã‚‹ï¼Ÿ
* ã™ã§ã« `FinalEnemyStats` ã‚’ä½œã£ã¦ã„ã‚‹ã¨æ€ã†ã®ã§ã€
  * ãã“ã« `agility` ç›¸å½“ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ **è¨ˆç®—ã—ã¦åŸ‹ã‚ã‚‹**
  * ã‚‚ã—ãã¯ `speed` / `initiative_base` ã¿ãŸã„ãªåå‰ã§ã‚‚OK
JSON ã‚’æ›¸ãæ›ãˆã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
**ã€Œãƒ­ãƒ¼ãƒ‰æ™‚ã«å‹æ‰‹ã«è¨ˆç®—ã—ã¦ Stats ã«ã ã‘æŒã¤ã€** å½¢ã«ã™ã‚‹ã®ãŒæ¥½ã§ã™ã€‚

---
## æ“¬ä¼¼ Agility ã®ä½œã‚Šæ–¹ã®ä¾‹
æ•µ JSON ã«ã¯ã ã„ãŸã„ã“ã‚“ãªæƒ…å ±ãŒã‚ã‚Šã¾ã™ã­ï¼š
* `Level`
* `Attack.Count`
* `Evasion.Rate`ï¼ˆ0.1 ãªã‚‰ 10%ï¼‰
* `Accuracy` ãªã©
ã“ã‚Œã‚‰ã‚’ä½¿ã£ã¦ **ã€Œé€Ÿãã†ãªæ•µã¯æ—©ãå‹•ãã€** ç¨‹åº¦ã®ä»®ãƒ«ãƒ¼ãƒ«ã‚’ä½œã‚Šã¾ã™ã€‚

### ä¾‹1ï¼šLevel + Attack å›æ•° + å›é¿ç‡ ã‹ã‚‰ä½œã‚‹
```python
def enemy_base_agility(enemy_json: dict) -> int:
    lvl = int(enemy_json.get("Level", 1))

    atk = enemy_json.get("Attack") or {}
    atk_count = atk.get("Count")
    if atk_count is None:
        atk_count = 1

    eva = enemy_json.get("Evasion") or {}
    eva_rate = float(eva.get("Rate") or 0.0)  # 0.0ã€œ1.0 ã‚’æƒ³å®š

    # ãƒ™ãƒ¼ã‚¹ã¯ãƒ¬ãƒ™ãƒ«
    agi = lvl

    # æ”»æ’ƒå›æ•°ãŒå¤šã„æ•µã¯æ‰‹æ•°ãŒå¤šã„ï¼ç´ æ—©ã‚æ‰±ã„
    # Count=1 â†’ +0, Count=3 â†’ +4 ã¿ãŸã„ãªæ„Ÿã˜
    if atk_count > 1:
        agi += 2 * (atk_count - 1)

    # å›é¿ç‡ãŒé«˜ã„æ•µã‚‚ç´ æ—©ã„ã‚¤ãƒ¡ãƒ¼ã‚¸
    # Rate=0.1 â†’ +2, Rate=0.5 â†’ +10 ãã‚‰ã„ã®ãƒãƒª
    agi += int(eva_rate * 20)

    return max(1, agi)
```

ãã—ã¦ `FinalEnemyStats` ã‚’ä½œã‚‹ã¨ã“ã‚ã§ï¼š
```python
enemy_stats.agility = enemy_base_agility(enemy_json)
```

ã¨å…¥ã‚Œã¦ãŠã‘ã°ã€ã‚ã¨ã¯ã‚­ãƒ£ãƒ©ã¨åŒã˜ã‚ˆã†ã«
```python
def calc_initiative_for_enemy(enemy_stats, rng):
    agi = getattr(enemy_stats, "agility", 10)
    return agi + rng.randint(0, max(1, agi))
```
ã¿ãŸã„ã«ä½¿ãˆã¾ã™ã€‚

---

## ã€Œãƒ©ãƒ³ãƒ€ãƒ å‰²ã‚Šè¾¼ã¿ã€å‘³ã¯æ®‹ã™ãªã‚‰
å®Œå…¨ã«åŒã˜å¼ã§ã‚‚ã„ã„ã§ã™ãŒã€
* å‘³æ–¹ï¼š`agi + randint(0, agi)`
* æ•µã€€ï¼š`(agi // 2) + randint(0, agi * 2)`

ã¿ãŸã„ã«ã™ã‚‹ã¨ã€
* æ•µã¯ **ãƒ–ãƒ¬ãŒå¤§ããã¦ãŸã¾ã«ã™ã”ãæ—©ãå‹•ã**
* ã§ã‚‚å¹³å‡çš„ã«ã¯å‘³æ–¹ã®ç´ æ—©ã•ã«å¾“ã†

ã¨ã„ã†ã€Œå‰²ã‚Šè¾¼ã¿ã£ã½ã•ã€ã‚’å‡ºã›ã¾ã™ã€‚

---
## ã‚‚ã£ã¨ç°¡å˜ã«ã™ã‚‹å ´åˆ
ã€Œé›£ã—ãè€ƒãˆãŸããªã„ã€ã¾ãšã¯å‹•ã‹ã—ãŸã„ã€ãªã‚‰ã€
**ãƒ¬ãƒ™ãƒ«ã ã‘ã‚’ç´ æ—©ã•ã¨ã¿ãªã™**ã®ã§ã‚‚å‹•ãã¾ã™ã€‚

```python
def enemy_base_agility_simple(enemy_json: dict) -> int:
    return max(1, int(enemy_json.get("Level", 1)))
```

ã‚ã¨ã‹ã‚‰
* ã€Œãƒœã‚¹ã¯ã‚‚ã†ã¡ã‚‡ã£ã¨æ—©ãã—ãŸã„ã€
* ã€Œå¤šæ®µæ”»æ’ƒã™ã‚‹æ•µã¯é€Ÿãæ„Ÿã˜ã¦ã»ã—ã„ã€

ã¨æ€ã£ãŸã¨ã“ã‚ã§ã€ä¸Šã®ã‚ˆã†ãªå¼ã«å·®ã—æ›¿ãˆã‚Œã°OKã§ã™ã€‚

---

## ã¾ã¨ã‚
* âœ… `save["party"]` ã‚’è¤‡æ•°ãƒ¡ãƒ³ãƒãƒ¼ã«ã—ã¦ã€**æ¯ã‚¿ãƒ¼ãƒ³ã€Œè¡Œå‹•é †ãƒªã‚¹ãƒˆã€ã‚’ä½œã‚‹**è¨­è¨ˆã¯ãã®ã¾ã¾ã§è‰¯ã„
* â— ãŸã ã—ã€ãã®ãŸã‚ã«ã¯ **æ•µã«ã‚‚ã€Œinitiative ã®å…ƒã«ãªã‚‹å€¤ã€ãŒå¿…è¦**
* âœ… ãã‚Œã¯ **JSON ãƒ­ãƒ¼ãƒ‰æ™‚ã« `FinalEnemyStats` ã«è¨ˆç®—ã—ã¦å…¥ã‚Œã‚‹**ã®ãŒãã‚Œã„

  * `Level` / `Attack.Count` / `Evasion.Rate` ã‹ã‚‰ã€Œæ“¬ä¼¼ Agilityã€ã‚’ä½œã‚‹ã®ãŒãŠã™ã™ã‚
* âœ… ãã†ã™ã‚Œã°ã€å‘³æ–¹ã‚‚æ•µã‚‚å…±é€šã® `calc_initiative(actor_stats, rng)` ã§1è¡Œå‹•å˜ä½ã®é †ç•ªãŒæ±ºã‚ã‚‰ã‚Œã¾ã™

ã‚‚ã—ã‚ˆã‘ã‚Œã°ã€`FinalEnemyStats` ã®å®šç¾©éƒ¨åˆ†ï¼ˆ`NamedTuple` / `dataclass` ãªã©ï¼‰ãŒåˆ†ã‹ã‚Œã°ã€
ãã“ã«ã©ã†ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¶³ã—ã¦ã€ã©ã“ã§å€¤ã‚’å…¥ã‚Œã‚‹ã‹ã¾ã§ã‚³ãƒ¼ãƒ‰ã§ä¸€ç·’ã«æ•´ç†ã—ã¾ã™ã‚ˆã€‚
--------------
ã¯ã„ã€ã“ã“ã¾ã§è²¼ã£ã¦ã„ãŸã ã„ãŸæƒ…å ±ãŒã‚ã‚Œã°ã€
party_members / enemies ã‚’ã©ã†ã„ã†ã‚¿ãƒ—ãƒ«ï¼ˆor ã‚¯ãƒ©ã‚¹ï¼‰ã§æŒã¤ã‹ã‚’ã€ã‹ãªã‚Šã¯ã£ãã‚Šæ±ºã‚ã‚‰ã‚Œã¾ã™ã€‚

ä»Šã‚ã‚‹æµã‚Œã¯ã–ã£ãã‚Šè¨€ã†ã¨ï¼š
ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ party_entry ã‹ã‚‰
â†’ character_from_party_entry(entry, jobs_by_name) ã§
â†’ base, eq, char_state ã‚’ä½œã‚‹

ãã“ã‹ã‚‰
â†’ compute_character_final_stats(base, eq, weapons, armors, job_name) ã§
â†’ FinalCharacterStats ã‚’ä½œã‚‹

æ•µå´ã¯ï¼š
enemy_json = monsters[enemy_name]
enemy_final = compute_enemy_final_stats(enemy_json)ï¼ˆâ†ã“ã“ã§ agility ã‚‚ç”Ÿãˆã¦ã„ã‚‹ï¼‰
enemy_state = BattleActorState(...)
ãªã®ã§ã€ãƒãƒ«ãƒãƒ‘ãƒ¼ãƒ†ã‚£æˆ¦ã® 1 ãƒ¦ãƒ‹ãƒƒãƒˆã¯ã ã„ãŸã„æ¬¡ã®3è¦ç´ ï¼ˆï¼‹æ•µã¯å…ƒJSONï¼‰ã§æŒã¤ã®ãŒãã‚Œã„ã§ã™ã€‚

1. PartyMember / EnemyUnit ã®å‹ã‚’æ±ºã‚ã‚‹
2. æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ PartyMember / EnemyUnit ã‚’çµ„ã¿ç«‹ã¦ã‚‹ä¾‹
3. simulate_one_round_multi_party ã‚’ã“ã®å‹ã«åˆã‚ã›ã¦æ›¸ã

--------------
ä¸€ç•ªå¤§ããªãƒã‚¤ãƒ³ãƒˆã¯ã€
1. ã€Œè¡Œå‹•å…¥åŠ›ãƒ•ã‚§ãƒ¼ã‚ºã€ã¨ã€Œè¡Œå‹•è§£æ±ºãƒ•ã‚§ãƒ¼ã‚ºã€ã‚’åˆ†é›¢ã™ã‚‹
2. è¡Œå‹•è§£æ±ºãƒ•ã‚§ãƒ¼ã‚ºã§ã¯ã€ãƒ‘ãƒ¼ãƒ†ã‚£ï¼‹æ•µã‚’ã¾ã¨ã‚ã¦ã‚¤ãƒ‹ã‚·ã‚¢ãƒ†ã‚£ãƒ–é †ã«å›ã™
ã“ã®2ã¤ã ã‘ã§ã™ã€‚

# æ•µã®æ“¬ä¼¼ Agilityã®ä½œæˆï¼ˆLevel + Attack å›æ•° + å›é¿ç‡ ã‹ã‚‰ä½œã‚‹ï¼‰
def compute_enemy_base_agility(monster: Dict[str, Any]) -> int:
    """
    æ•µ JSON ã‹ã‚‰ã€Œè¡Œå‹•é †æ±ºå®šç”¨ã®æ“¬ä¼¼ Agilityã€ã‚’è¨ˆç®—ã™ã‚‹ã€‚
    - Level ãŒé«˜ã„æ•µã»ã©ç´ æ—©ã
    - Attack.Count ãŒå¤šã„æ•µã¯æ‰‹æ•°ãŒå¤šã„ï¼ç´ æ—©ã„å°è±¡ã«
    - Evasion.Rate ãŒé«˜ã„æ•µã‚‚ç´ æ—©ã„å°è±¡ã«
    """
    lvl = int(monster.get("Level", 1))

    atk = monster.get("Attack") or {}
    atk_count = int(atk.get("Count") or 1)

    ev = monster.get("Evasion") or {}
    eva_rate = float(ev.get("Rate") or 0.0)  # 0.1 â†’ 10% ã¿ãŸã„ãªå€¤

    # é©å½“ãªæŒ‡æ¨™ï¼šã‚ã¨ã§å¥½ãã«èª¿æ•´ã—ã¦OK
    agi = lvl
    agi += 2 * max(0, atk_count - 1)   # æ”»æ’ƒå›æ•°ãŒå¤šã„ã»ã© +2, +4, ...
    agi += int(eva_rate * 20)          # å›é¿ 10% â†’ +2, 50% â†’ +10 ãã‚‰ã„ã®ãƒãƒª

    return max(1, agi)
--------------


# æ•µâ†’ã‚­ãƒ£ãƒ©ã€Œç´”ç²‹ãªå…¨ä½“æ”»æ’ƒã€ï¼ˆSnowstormç­‰ï¼‰ç”¨ã®æ±ç”¨ãƒ˜ãƒ«ãƒ‘
# normal: ãƒ€ãƒ¡ãƒ¼ã‚¸æ”»æ’ƒã€ratio: å‰²åˆå‰Šã‚Š
3488 def enemy_cast_aoe_damage_spell_to_party(



# ============================================================
# ã‚¢ã‚¤ãƒ†ãƒ åŠ¹æœç”¨ãƒ˜ãƒ«ãƒ‘ï¼ˆå›å¾©ãƒ»è˜‡ç”Ÿãƒ»çŠ¶æ…‹ç•°å¸¸å›å¾©ï¼‰
# ============================================================
def apply_item_effect_to_actor(
# 0) Hasteç³»ãƒãƒ•ã‚¢ã‚¤ãƒ†ãƒ ï¼ˆBacchus's Ciderï¼‰ *
# 0-b) Protectç³»ãƒãƒ•ã‚¢ã‚¤ãƒ†ãƒ ï¼ˆTurtle Shellï¼‰ *

# ============================================================
# 1ã‚¿ãƒ¼ãƒ³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
# ============================================================
def simulate_one_turn(
elif char_attack_kind == "magic":
# â‘£ Protectï¼šé˜²å¾¡ãƒ»é­”æ³•é˜²å¾¡ã‚¢ãƒƒãƒ— *
# â‘¤ Hasteï¼šæ”»æ’ƒåŠ›ãƒ»æ”»æ’ƒå›æ•°ã‚¢ãƒƒãƒ— *
else:
# é€šå¸¸ã®æ•µè¡Œå‹•ï¼ˆã‚¹ãƒšã‚·ãƒ£ãƒ«è¾¼ã¿ï¼‰
# 4) Haste / Protectï¼ˆæ•µè‡ªèº«ã®è‡ªå·±ãƒãƒ•ï¼‰ç°¡æ˜“æ¡ˆ
elif name_lower == "haste": *
elif name_lower == "protect": *



# å±æ€§ç›¸æ€§ã‚³ãƒ¡ãƒ³ãƒˆ
def relation_comment(

4260 å¼±ç‚¹ã‚’çªã„ãŸ *
5024 å¼±ç‚¹ã‚’çªã„ãŸ *
5116 å¼±ç‚¹ã‚’çªã„ãŸ *
5673 å¼±ç‚¹ã‚’çªã„ãŸ *
6235 å¼±ç‚¹ã‚’çªã‹ã‚ŒãŸ *


2384 # ãƒ€ãƒ¡ãƒ¼ã‚¸ãƒ­ã‚°
def log_damage(

def simulate_one_turn(
4141 f"{char_name}ã¯æ¯’ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸï¼" f"ï¼ˆ{poison_dmg_char} â†’ {char_state.hp}/{max_hp_char}ï¼‰" *
4159 f"{enemy_name}ã¯æ¯’ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸï¼" f"ï¼ˆ{poison_dmg_enemy} â†’ {enemy_state.hp}/{max_hp_enemy}ï¼‰" *

4253 f"{enemy_name}ã«{dmg_to_enemy}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼ï¼ˆ{enemy_name} æ®‹ã‚ŠHP: {enemy_state.hp}ï¼‰" *
4298 f"{enemy_name}ã«{dmg_to_enemy}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚ï¼ˆ{enemy_name} æ®‹ã‚ŠHP: {enemy_state.hp}ï¼‰" *
4304 f"{enemy_name}ã«{dmg_to_enemy}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚ï¼ˆ{enemy_name} æ®‹ã‚ŠHP: {enemy_state.hp}ï¼‰" *
4327 f"{char_name}ã¯{dmg_to_char_from_self}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚ï¼ˆ{char_name} æ®‹ã‚ŠHP: {char_state.hp}ï¼‰" *
4331 f"{char_name}ã¯{dmg_to_char_from_self}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚ï¼ˆ{char_name} æ®‹ã‚ŠHP: {char_state.hp}ï¼‰" *
4966 f"{char_name}ã¯{dmg_back}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸã€‚" f"ï¼ˆ{char_name} æ®‹ã‚ŠHP: {char_state.hp}ï¼‰ {suffix}" *
5096 f"{enemy_name}ã«{dmg_to_enemy}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚" f"ï¼ˆ{enemy_name} æ®‹ã‚ŠHP: {enemy_state.hp}ï¼‰ {suffix}" *
5180 f"{enemy_name}ã«{dmg_to_enemy}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚" f"ï¼ˆ{enemy_name} æ®‹ã‚ŠHP: {enemy_state.hp}ï¼‰" *
5486 f"ãƒãƒƒã‚¯ãƒ•ã‚¡ã‚¤ã‚¢ï¼{char_name}ã¯{backfire}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸï¼" f"ï¼ˆ{old_hp}â†’{char_state.hp}ï¼‰" *
5541 f"{enemy_name}ã«{final_damage}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼" f"ï¼ˆ{old_enemy_hp}â†’{enemy_state.hp}ï¼‰" *
5557 f"{enemy_name}ã«{final_damage}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼" f"ï¼ˆ{old_enemy_hp}â†’{enemy_state.hp}ï¼‰" *
5600 f"{char_name}ã¯ã‚ªãƒ¼ãƒãƒ¼ãƒ­ãƒ¼ãƒ‰ã§{overload_damage}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸã€‚" f"ï¼ˆ{char_name} æ®‹ã‚ŠHP: {char_state.hp}ï¼‰" *
5735 f"{enemy_name}ã«{dmg_to_enemy}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚" f"ï¼ˆ{enemy_name} æ®‹ã‚ŠHP: {enemy_state.hp}ï¼‰" *
5743 f"{enemy_name}ã«{dmg_to_enemy}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚" f"ï¼ˆ{enemy_name} æ®‹ã‚ŠHP: {enemy_state.hp}ï¼‰" *

5912 f"{enemy_name}ã¯{dmg_to_self}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚ï¼ˆ{enemy_name} æ®‹ã‚ŠHP: {enemy_state.hp}ï¼‰" *
5917 f"{enemy_name}ã¯{dmg_to_self}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚ï¼ˆ{enemy_name} æ®‹ã‚ŠHP: {enemy_state.hp}ï¼‰" *
5946 f"{char_name}ã¯{dmg_to_char}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚ï¼ˆ{char_name} æ®‹ã‚ŠHP: {char_state.hp}ï¼‰" *
5951 f"{char_name}ã¯{dmg_to_char}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚ï¼ˆ{char_name} æ®‹ã‚ŠHP: {char_state.hp}ï¼‰" *
5975 f"{char_name}ã¯{dmg_to_char}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸã€‚ï¼ˆ{char_name} æ®‹ã‚ŠHP: {char_state.hp}ï¼‰" *
5980 f"{char_name}ã¯{dmg_to_char}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸã€‚ï¼ˆ{char_name} æ®‹ã‚ŠHP: {char_state.hp}ï¼‰" *
6016 f"{enemy_name}ã¯{reflected_damage}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸã€‚ï¼ˆ{enemy_name} æ®‹ã‚ŠHP: {enemy_state.hp}ï¼‰" *
6267 f"{char_name}ã¯{dmg_to_char}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸã€‚" f"ï¼ˆ{char_name} æ®‹ã‚ŠHP: {char_state.hp}ï¼‰" *
6273 f"{char_name}ã¯{dmg_to_char}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸã€‚" f"ï¼ˆ{char_name} æ®‹ã‚ŠHP: {char_state.hp}ï¼‰" *
6291 f"{char_name}ã¯{dmg_to_char}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸã€‚" f"ï¼ˆ{char_name} æ®‹ã‚ŠHP: {char_state.hp}ï¼‰" *
6298 f"{char_name}ã¯{dmg_to_char}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸã€‚" f"ï¼ˆ{char_name} æ®‹ã‚ŠHP: {char_state.hp}ï¼‰" *



744 def parse_elements

870 elem_raw = spell_json.get("Element") or spell_json.get("Elements") or "" *
895 elem_raw = spell_json.get("Element") or spell_json.get("Elements") *
1155 final.main_weapon_elements = [str(e).strip().lower() for e in (main_weapon_elements or [])] *
1908 elements = [e.strip().lower() for e in elem_raw.split(",") if e.strip()] *
2488 elements = [e.strip() for e in elem_raw.split(",") if e.strip()] *
4989 elem_raw = (char_spell_json.get("Element") or char_spell_json.get("Elements") or """ *

<å‰Šé™¤ã§ããŸè²¬å‹™ï¼ˆé‡è¦ï¼‰>
ã“ã‚Œã ã‘ã®å‡¦ç†ãŒ ã™ã¹ã¦ parse_elements ã«é›†ç´„ã•ã‚Œã¾ã—ãŸï¼š
âœ… None / ç©ºæ–‡å­—ãƒã‚§ãƒƒã‚¯
âœ… "-" ãƒã‚§ãƒƒã‚¯
âœ… str or list åˆ†å²
âœ… split(",")
âœ… strip()
âœ… .lower()

âœ… è¨­è¨ˆçš„ãªãƒ¡ãƒªãƒƒãƒˆ
âœ… å…ƒç´ ãƒ‘ãƒ¼ã‚¹ãŒå…¨ã‚³ãƒ¼ãƒ‰ã§å®Œå…¨ã«åŒä¸€ä»•æ§˜ã«ãªã‚‹
âœ… é­”æ³•ãƒ»å¬å–šãƒ»æ­¦å™¨ãƒ»æ•µè€æ€§ãƒ»ã‚¢ã‚¤ãƒ†ãƒ åŠ¹æœãŒã™ã¹ã¦çµ±ä¸€
âœ… å°†æ¥ "Air / Ice" ãªã©å¤‰ãªãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒæ¥ã¦ã‚‚
â†’ parse_elements ã ã‘ç›´ã›ã°å…¨ä½“ãŒæ•‘ã‚ã‚Œã‚‹

âœ… ã“ã“ã¾ã§æ¥ã‚‹ã¨ã€ã€Œå±æ€§ã¾ã‚ã‚Šã®ãƒã‚°ã€ã¯æ§‹é€ çš„ã«ã»ã¼å°æ®ºã§ãã¦ã„ã¾ã™ã€‚

ã“ã“ã¾ã§ã§ï¼š
âœ… é­”æ³•
âœ… æ­¦å™¨
âœ… é˜²å…·
âœ… å¬å–š
âœ… æ•µã‚¹ãƒšãƒ«
âœ… Peep
âœ… æ”»æ’ƒç™½é­”åˆ¤å®š
ã™ã¹ã¦ parse_elements ã«çµ±ä¸€å®Œäº† ã§ã™ã­ã€‚


# ============================================================
# ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚å‡¦ç†ï¼ˆæ¯’ãªã©æ‹¡å¼µã—ã‚„ã™ãï¼‰
# ============================================================
3898 def start_of_turn_for_actor(


def apply_start_of_turn_effects(




â–  Red Mage ã®é­”æ³•ä½¿ç”¨åˆ¶é™
ï¼ˆRM ã¯ ç™½/é»’ Lv1ã€œ4 ã®ã¿ä½¿ç”¨å¯èƒ½ï¼‰

â–  é­”æ³•é¸æŠç”»é¢ã‹ã‚‰ã€Œä½¿ãˆãªã„é­”æ³•ã€ã‚’å‰Šé™¤
ï¼ˆCastBy="RM" ã‚’è¦‹ã¦ãƒ•ã‚£ãƒ«ã‚¿ï¼‰

â–  æœ€å¤§MPã¨ç¾åœ¨MPã®åŒºåˆ¥
ï¼ˆä»Šã¯ savedata ã® mp ãŒãã®ã¾ã¾æ®‹é‡ã«ãªã£ã¦ã„ã‚‹ï¼‰

â–  æˆ¦é—˜çµ‚äº†æ™‚ã« MP ã‚’ savedata ã«åæ˜ 
ï¼ˆã‚²ãƒ¼ãƒ ã¨ã—ã¦ã¯å¿…é ˆã‚¹ãƒ†ãƒƒãƒ—ï¼‰

ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç•°å¸¸ã‚’ä¸ãˆã‚‹é­”æ³•ã«ã¯ã€
é»’é­”æ³•ã®Sleepï¼ˆSleepï¼‰ã€Blindï¼ˆBlindï¼‰ã€Poisonï¼ˆPoisonï¼‰ã€Shadeï¼ˆParalysisï¼‰ã€Eraseï¼ˆKOï¼‰ã€Razeï¼ˆKOï¼‰ã€Warpï¼ˆKOï¼‰ã€Breakï¼ˆPartial Petrificationï¼‰ã€Breakgaï¼ˆPetrificationï¼‰ã€Deathï¼ˆKOï¼‰ã€
ç™½é­”æ³•ã®Miniï¼ˆMiniï¼‰ã€Toadï¼ˆToadï¼‰ã€Teleportï¼ˆKOï¼‰ã€Silenceï¼ˆSilenceï¼‰ã€Confuseï¼ˆConfuseï¼‰ãŒã‚ã‚Šã¾ã™ã€‚
ã¾ãŸã€"Status"ç•°å¸¸ä»˜ä¸åŠ¹æœã‚’æŒã¤å¬å–šé­”æ³•ã«ã¯ã€"Shiva: Mesmerize"ï¼ˆSleepï¼‰ã€"Ramuh: Mind Blast"ï¼ˆParalysisï¼‰ã€"Ifrit: Healing Light"ï¼ˆRecoveryï¼‰ã€"Leviathan: Demon Eye"ï¼ˆPetrificationï¼‰ãŒã‚ã‚Šã¾ã™ã€‚


-----
ç™½é­”æ³•"Protect"ã¨"Haste"ã¯ä»¥ä¸‹ã®ä»•æ§˜ã«ãªã£ã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚‰ã®é­”æ³•ã‚’æ·»ä»˜ã®ff3_calc.pyå†…ã«å®Ÿè£…ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

ç™½é­”æ³•"Protect"ï¼šdefenceã¨magic defenceã‚’å¢—åŠ ã•ã›ã‚‹ã€‚ï¼ˆ<=255ã€ç´¯ç©å¯èƒ½ï¼‰
"Protect"ã®å‘½ä¸­ç‡% = BaseAccuracy% + mind/2 (<=100%)
additional defence = BasePower * (mind/16 + level/16 + job_level/32 + 1) * 1ï½1.5
additional magic_defence = BasePower * (mind/16 + level/16 + job_level/32 + 1) * 1ï½1.5

    {
      "name": "Protect",
      "Type": "White Magic",
      "Level": 5,
      "Effect": "Enhance Defense and Magic Defense",
      "BasePower": 5,
      "BaseAccuracy": 0.75,
      "Price": 5000,
      "Value": 2500,
      "Reflectable": "No",
      "Target": "One Enemy",
      "CastBy": [
        "WM",
        "De",
        "Sa"
      ],

ç™½é­”æ³•"Haste"ï¼šattack powerã€attack multiplierã‚’å¢—åŠ ã•ã›ã‚‹ã€‚ï¼ˆattack power<=255ã€attack multiplier<=æœ€å¤§16ã€ç´¯ç©å¯èƒ½ï¼‰
"Haste"ã®å‘½ä¸­ç‡% = BaseAccuracy% + mind/2 (<=100%)
additional attack power = BasePower * (mind/16 + level/16 + job_level/32 + 1) * 1ï½1.5
additional attack multiplier = mind/16 + level/16 + job_level/32 + 1

æ·»ä»˜ã®Spellsãƒ‡ãƒ¼ã‚¿ã§ã¯ã€ç™½é­”æ³•"Protect"ã€"Haste"ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‹ã‚‰ã€"Protect"ã®å‘½ä¸­ç‡ã®è¨ˆç®—å¼ã®75ã¨ã€"Haste"ã®å‘½ä¸­ç‡ã®è¨ˆç®—å¼ã®16ã¯BaseAccuracyã®ãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚ãã®ç‚¹ã«ã¤ã„ã¦ä¿®æ­£ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚

    {
      "name": "Protect",
      "Type": "White Magic",
      "Level": 5,
      "Effect": "Enhance Defense and Magic Defense",
      "BasePower": 5,
      "BaseAccuracy": 0.75,
      "Price": 5000,
      "Value": 2500,
      "Reflectable": "No",
      "Target": "One Enemy",
      "CastBy": [
        "WM",
        "De",
        "Sa"
      ],

    {
      "name": "Haste",
      "Type": "White Magic",
      "Level": 6,
      "Effect": "Enhance Accuracy and Attack Multiplier",
      "BasePower": 5,
      "BaseAccuracy": 0.16,
      "Price": 10000,
      "Value": 5000,
      "Reflectable": "No",
      "Target": "One Enemy",
      "CastBy": [
        "WM",
        "De",
        "Sa"
      ],

<å®Ÿè£…ä¸Šã®ãƒã‚¤ãƒ³ãƒˆæ•´ç†>

å‘½ä¸­ç‡
Protect: hit% = 75 + mind//2ï¼ˆæœ€å¤§100ï¼‰
Haste : hit% = 16 + mind//2ï¼ˆæœ€å¤§100ï¼‰
rng.random() * 100 < hit% ã§åˆ¤å®šã€‚

åŸºæœ¬ä¿‚æ•°ï¼ˆä¸¡æ–¹å…±é€šï¼‰
base_factor = (mind // 16) + (level // 16) + (job_level // 32) + 1

Protect ã®å¢—åŠ é‡
base_amount = 5 * base_factor
rand_mul = 1.0 + rng.random() * 0.5     # 1.0ã€œ1.5
add_value = int(base_amount * rand_mul)
ã‚’ defense ã¨ magic_defense ã«åŠ ç®—ã—ã€255ã§ã‚¯ãƒ©ãƒ³ãƒ—ã€‚

Haste ã®å¢—åŠ é‡
attack power ç”¨: 5 * base_factor * (1ã€œ1.5) â†’ main_power / off_power ã«åŠ ç®—ï¼ˆ255ã¾ã§ï¼‰ã€‚
attack multiplier ç”¨: base_factor â†’ main_atk_multiplier / off_atk_multiplier ã«åŠ ç®—ï¼ˆ16ã¾ã§ï¼‰ã€‚

ç´¯ç©å¯èƒ½
å˜ã«ã€Œä»Šã®å€¤ã«åŠ ç®—ã—ã¦ä¸Šé™ã§ã‚¯ãƒªãƒƒãƒ—ã€ã—ã¦ã„ã‚‹ã®ã§ã€åŒä¸€ã‚¿ãƒ¼ãƒ³ä¸­ã§ã‚‚è¤‡æ•°ã‚¿ãƒ¼ãƒ³ã«æ¸¡ã£ã¦ã‚‚ã€
åŒã˜ FinalCharacterStats ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ã„å›ã›ã°ãã®ã¾ã¾ç´¯ç©ã—ã¾ã™ã€‚

<ä½¿ç”¨çµæœ>
"job": mind : 55, "Sage", "level": 12, "job_level": 24
ãƒ«ãƒ¼ãƒã‚¹ã¯ã€ŠProtectã€‹ã‚’å”±ãˆãŸï¼ é˜²å¾¡åŠ› 25â†’54ã€é­”æ³•é˜²å¾¡ 6â†’35 ã«ä¸ŠãŒã£ãŸã€‚ ï¼ˆMP5 0/19ï¼‰
ãƒ«ãƒ¼ãƒã‚¹ã¯ã€ŠHasteã€‹ã‚’å”±ãˆãŸï¼ æ”»æ’ƒåŠ› å³æ‰‹ 67â†’89ã€æ”»æ’ƒå›æ•° å³æ‰‹ 3â†’7 ã«ä¸ŠãŒã£ãŸã€‚ ï¼ˆMP6 0/15ï¼‰

-----
ç™½é­”æ³•"Toad"ãƒ»"Mini"ï¼šæˆåŠŸã™ã‚‹ã¨æ•µã¯é€ƒã’ã¦KOã¨ãªã‚‹ã€‚
Magic Hit% = (Spell Hit%) + (Mind/2)

    {
      "name": "Toad",
      "Type": "White Magic",
      "Level": 2,
      "Effect": "Turn target into a toad",
      "StatusAilment": "Toad",
      "BasePower": 0,
      "BaseAccuracy": 0.0,
      "Price": 700,
      "Value": 350,
      "Reflectable": "No",
      "Target": "One Enemy",
      "CastBy": [
        "WM",
        "RM",
        "Ra",
        "MK",
        "De",
        "Sa"
      ],
    {
      "name": "Mini",
      "Type": "White Magic",
      "Level": 2,
      "Effect": "Miniaturize target",
      "StatusAilment": "Mini",
      "BasePower": 0,
      "BaseAccuracy": 0.0,
      "Price": 700,
      "Value": 350,
      "Reflectable": "No",
      "Target": "One Enemy",
      "CastBy": [
        "WM",
        "RM",
        "Ra",
        "MK",
        "De",
        "Sa"
      ],

<ä»¥ä¸‹ã®ä»•æ§˜ã§å®Ÿè£…ã—ã¾ã™>
æˆåŠŸã—ãŸã‚‰æ•µã¯ é€ƒã’ã¦ KOï¼ˆï¼HP0ã€Status.KO ã‚’ä»˜ä¸ï¼‰
æˆåŠŸç‡ Magic Hit% = BaseAccuracy + (Mind / 2)
â€»ä»Šå› BaseAccuracy=0 ã®ãŸã‚ Mind / 2 % ãŒãã®ã¾ã¾å‘½ä¸­ç‡ã«ãªã‚‹
å¤±æ•—ã—ãŸã‚‰ä½•ã‚‚èµ·ããªã„
æ•µãŒã€Œç„¡åŠ¹ï¼ˆImmuneï¼‰ã€ãªã‚‰å¿…ãšå¤±æ•—

-----
LV5é»’é­”æ³•"Erase"(Kill)ï¼šæ•µå…¨å“¡ã‚’KOã«ã™ã‚‹ã€‚
Magic Hit% = BaseAccuracy% + (Mind/2)
IF Target Level >= (Attacker Level)*3/4
Magic Hit% = 0

ãªãŠã€"Erase"ã®ãƒ‡ãƒ¼ã‚¿ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã€‚
    {
      "name": "Erase",
      "Type": "Black Magic",
      "Level": 5,
      "Effect": "Remove Reflect (doesn't work)",
      "BasePower": 0,
      "BaseAccuracy": 0.6,
      "Price": 5000,
      "Value": 2500,
      "Reflectable": "No",
      "Target": "One/All Enemies",
      "CastBy": [
        "BM",
        "Ma",
        "Sa"
      ],

<ã‚„ã‚ŠãŸã„ã“ã¨>
å¯¾è±¡ï¼šé»’é­”æ³• "Erase"
åŠ¹æœï¼šæ•µï¼ˆå°†æ¥çš„ã«ã¯æ•µå…¨å“¡ï¼‰ã‚’ KO ã«ã™ã‚‹
å‘½ä¸­ç‡ï¼šMagic Hit% = BaseAccuracy% + (Mind/2)
ï¼ˆBaseAccuracy ã¯ 0.6 â†’ 60% ã®æ‰±ã„ï¼‰
ãŸã ã— IF Target Level >= (Attacker Level)*3/4: Magic Hit% = 0
KO è€æ€§ãŒã‚ã‚‹æ•µï¼ˆImmune ã« "KO" ãŒã‚ã‚‹æ•µï¼‰ã¯ç„¡åŠ¹

-----
ç™½é­”æ³•"Tornado"ï¼šæ•µã®HPã‚’ä¸€æ¡ï¼ˆ1ï½9ï¼‰ã«ã¾ã§æ¸›å°‘
Magic Hit% = BaseAccuracy% + (Mind/2)

ãªãŠã€"Tornado"ã®ãƒ‡ãƒ¼ã‚¿ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã€‚
    {
      "name": "Tornado",
      "Type": "White Magic",
      "Level": 8,
      "Effect": "Set target's HP to critical",
      "Element": "Air",
      "BasePower": 4,
      "BaseAccuracy": 0.4,
      "Price": 60000,
      "Value": 30000,
      "Reflectable": "No",
      "Target": "One/All Enemies",
      "CastBy": [
        "De",
        "Sa"
      ],

<æŒ™å‹•ã®æ–¹é‡>
å¯¾è±¡ï¼šç™½é­”æ³• Tornadoï¼ˆname = "Tornado"ï¼‰
åŠ¹æœï¼šå‘½ä¸­ã—ãŸã‚‰æ•µã® HP ã‚’ 1ã€œ9 ã®ãƒ©ãƒ³ãƒ€ãƒ ãªå€¤ã«ã™ã‚‹
ãŸã ã— ç¾åœ¨ HP ä»¥ä¸‹ã«ã™ã‚‹ï¼ˆå›å¾©ã¯ã—ãªã„ï¼‰
å‘½ä¸­ç‡ï¼šMagic Hit% = BaseAccuracy% + (Mind/2)
BaseAccuracy ãŒ 0.4 â†’ 40% ã¨ã—ã¦æ‰±ã†ï¼ˆToad / Mini ã®å‡¦ç†ã¨åŒã˜ï¼‰
å¤–ã‚ŒãŸå ´åˆï¼š
HP å¤‰åŒ–ãªã—,ã€ŒåŠ¹ã‹ãªã‹ã£ãŸâ€¦ï¼ˆå‘½ä¸­ç‡xx.x% åˆ¤å®šyy.yï¼‰ã€ãƒ­ã‚°

-----
ç™½é­”æ³•"Reflect"ï¼šReflectçŠ¶æ…‹ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã«æ›ã‘ã‚‰ã‚ŒãŸSpellï¼ˆ"Reflectable": "Yes"ã®Spellï¼‰ã‚’1å›è·³ã­è¿”ã™ã€‚
è·³ã­è¿”ã—ãŸå¾Œã€ReflectçŠ¶æ…‹ã¯æ¶ˆå¤±ã™ã‚‹ã€‚
Magic Hit% = BaseAccuracy% + (Mind/2)

ãªãŠã€"Tornado"ã®ãƒ‡ãƒ¼ã‚¿ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã€‚
    {
      "name": "Reflect",
      "Type": "White Magic",
      "Level": 7,
      "Effect": "Grant Reflect",
      "BasePower": 0,
      "BaseAccuracy": 0.75,
      "Price": 20000,
      "Value": 10000,
      "Reflectable": "No",
      "Target": "One Enemy",
      "CastBy": [
        "WM",
        "De",
        "Sa"
      ],

<ãƒã‚¤ãƒ³ãƒˆ>
1. ã€ŒReflectable: Yesã€ã‹ã©ã†ã‹ã‚’è¦‹ã¦ã€å¯¾è±¡ã« reflect_charges ãŒã‚ã‚Œã°è·³ã­è¿”ã™
2. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é­”æ³• â†’ æ•µReflect ã¨ æ•µã‚¹ãƒšã‚·ãƒ£ãƒ«ï¼ˆSpellï¼‰ â†’ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼Reflect ã®ä¸¡æ–¹ã§åŒã˜è€ƒãˆæ–¹ã«ã™ã‚‹

æ•µã‚¹ãƒšãƒ« spell_def ã« Reflectable ãŒç„¡ã„
â†’ åŒåã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç”¨ spellï¼ˆspells.json ã® nameï¼‰ã‚’å‚ç…§ã—ã¦ Reflectable ã‚’è£œå®Œ

é­”æ³•åå°„ã®ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—
ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é­”æ³•æ”»æ’ƒã«ãŠã‘ã‚‹åå°„å‡¦ç†ã§ã¯ã€ff3_confused_self_dummy_enemyã‚’ä½¿ç”¨ã—ã¦ãƒ€ãƒŸãƒ¼æ•µã‚’ä½œæˆã—ã€é­”æ³•ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’è¨ˆç®—ã€‚ãã®å¾Œã€ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®HPã‹ã‚‰å·®ã—å¼•ãã€åå°„ã®ãƒ­ã‚°ã‚’è¨˜éŒ²ã—ã¾ã™ã€‚æ•µã®æ”»æ’ƒã§ã‚‚åŒæ§˜ã®å‡¦ç†ã‚’è¡Œã„ã€æ­£ã—ã„ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—ã‚’è¡Œã„ã¾ã™ã€‚

-----
é»’é­”æ³•"Drain"ï¼šå¯¾è±¡ã«ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆãŸåˆ†ã€ä½¿ç”¨è€…ã®hpã‚’å›å¾©ã™ã‚‹
Magic Hit% = BaseAccuracy% + (Intelligence/2)

ãªãŠã€"Drain"ã®ãƒ‡ãƒ¼ã‚¿ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã€‚
    {
      "name": "Drain",
      "Type": "Black Magic",
      "Level": 7,
      "Effect": "Absorb HP from target",
      "Element": "Recovery",
      "BasePower": 160,
      "BaseAccuracy": 1.0,
      "Price": 20000,
      "Value": 10000,
      "Reflectable": "No",
      "Target": "One Enemy",
      "CastBy": [
        "BM",
        "Ma",
        "Sa"
      ],

é€šå¸¸ã®é­”æ³•ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—ã§ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ç®—å‡º
æœ€çµ‚çš„ã«ä¸ãƒ€ãƒ¡ãƒ¼ã‚¸é‡ã ã‘ caster_state.hp ã‚’å›å¾©ã™ã‚Œã° OK

-----
ã‚¢ã‚¤ãƒ†ãƒ "Bacchus's Cider": ç™½é­”æ³•"Haste"ã¨åŒæ§˜ã®åŠ¹æœï¼ˆMultiplierã¯3ã§å›ºå®šï¼‰
ãªãŠã€ã‚¢ã‚¤ãƒ†ãƒ ãƒ‡ãƒ¼ã‚¿ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã€‚
    {
      "Name": "Bacchus's Cider",
      "ItemType": "Combat",
      "Value": 1500,
      "SpellEffect": "Haste",
      "SpellInfo": {
        "Effect": "Enhance Accuracy and Attack Multiplier",
        "Element": null,
        "BasePower": 5,
        "BaseAccuracy": 0.16,
        "Reflectable": "No",
        "Target": "One Enemy",
        "Multiplier": 3
      },

æ—¢å­˜ã® Haste ã®è¨ˆç®—å¼ï¼ˆå‘½ä¸­ç‡ãƒ»æ”»æ’ƒåŠ›ã‚¢ãƒƒãƒ—é‡ï¼‰ã‚’ãã®ã¾ã¾æµç”¨ã€‚
ãŸã ã— æ”»æ’ƒå›æ•°ã®å¢—åˆ† add_mul ã ã‘ã‚’å›ºå®š 3 ã«ã™ã‚‹ã€‚

-----
ã‚¢ã‚¤ãƒ†ãƒ "Shining Curtain": ç™½é­”æ³•"Reflect"ã¨åŒæ§˜ã®åŠ¹æœ
ãªãŠã€ã‚¢ã‚¤ãƒ†ãƒ ãƒ‡ãƒ¼ã‚¿ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã€‚
    {
      "Name": "Shining Curtain",
      "ItemType": "Combat",
      "Value": 2500,
      "SpellEffect": "Reflect",
      "SpellInfo": {
        "Effect": "Grant Reflect",
        "Element": null,
        "BasePower": 0,
        "BaseAccuracy": 0.75,
        "Reflectable": "No",
        "Target": "One Enemy",
        "Multiplier": 3
      },

å‘½ä¸­ç‡ï¼šBaseAccuracy% + Mind/2ï¼ˆç™½é­” Reflect ã¨åŒã˜å¼ï¼‰
æˆåŠŸã—ãŸã‚‰ char_state.reflect_charges = 1
ãƒ­ã‚°ã‚‚ Reflect ã¨åŒã˜ãƒãƒªã ãŒã€ã€Œå”±ãˆãŸã€ã§ã¯ãªãã€Œä½¿ã£ãŸã€ã«ã™ã‚‹
MP æ¶ˆè²»ã¯ã‚‚ã¡ã‚ã‚“ãƒŠã‚·

-----
ã‚¢ã‚¤ãƒ†ãƒ "Turtle Shell": ç™½é­”æ³•"Protect"ã¨åŒæ§˜ã®åŠ¹æœï¼ˆMultiplierã¯3ã§å›ºå®šï¼‰
ãªãŠã€ã‚¢ã‚¤ãƒ†ãƒ ãƒ‡ãƒ¼ã‚¿ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã€‚
    {
      "Name": "Turtle Shell",
      "ItemType": "Combat",
      "Value": 1500,
      "SpellEffect": "Protect",
      "SpellInfo": {
        "Effect": "Enhance Defense and Magic Defense",
        "Element": null,
        "BasePower": 5,
        "BaseAccuracy": 0.75,
        "Reflectable": "No",
        "Target": "One Enemy",
        "Multiplier": 3
      },

åˆ¤å®šå¼ï¼ä¸Šæ˜‡é‡ã¯ ç™½é­”æ³• Protect ã¨åŒã˜
ãŸã ã—
MP æ¶ˆè²»ãªã—
ãƒ­ã‚°æ–‡è¨€ã¯ã€Œã€ŠProtectã€‹ã‚’å”±ãˆãŸï¼ã€ã§ã¯ãªãã€ŒTurtle Shell ã‚’ä½¿ã£ãŸï¼ã€
Multiplier=3 ã¯ãƒ‡ãƒ¼ã‚¿å´ã«å…¥ã£ã¦ã„ã‚‹ã ã‘ã§ã€é˜²å¾¡ãƒãƒ•è¨ˆç®—ã§ã¯ä½¿ã£ã¦ã„ãªã„ï¼ˆé­”æ³•å´ã‚‚ä½¿ã£ã¦ã„ãªã„ã®ã§åŒã˜æ‰±ã„ï¼‰

-----
ã‚¢ã‚¤ãƒ†ãƒ "Lilith's Kiss": é»’é­”æ³•"Drain"ã¨åŒæ§˜ã®åŠ¹æœï¼ˆMultiplierã¯3ã§å›ºå®šï¼‰
ãªãŠã€ã‚¢ã‚¤ãƒ†ãƒ ãƒ‡ãƒ¼ã‚¿ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã€‚
    {
      "Name": "Lilith's Kiss",
      "ItemType": "Combat",
      "Value": 1500,
      "SpellEffect": "Drain",
      "SpellInfo": {
        "Effect": "Absorb HP from target",
        "Element": "Recovery",
        "BasePower": 160,
        "BaseAccuracy": 1.0,
        "Reflectable": "No",
        "Target": "One Enemy",
        "Multiplier": 3
      },

ã€Œæ”»æ’ƒã‚¢ã‚¤ãƒ†ãƒ ã€åˆ¤å®šã« Lilith's Kiss ã‚’åŠ ãˆã‚‹
ãƒ€ãƒ¡ãƒ¼ã‚¸å¾Œã« Drain ã¨åŒã˜ HP å¸åå‡¦ç†ã‚’è¿½åŠ 

-----
å¬å–šé­”æ³•"Odin: Protective Light"ï¼šãƒ‘ãƒ¼ãƒ†ã‚£å…¨ä½“ã«"Reflect"ã‚’ä»˜ä¸ã™ã‚‹ã€‚
Call Magic Power = (Spell Damage) + (Intelligence)
Call Magic Multiplier = (Intelligence/8) + (((JobLevel/8)*3)/2) + 1
Call Magic Accuracy% = (Spell Accuracy%) + (Intelligence)

ãªãŠã€Spellsãƒ‡ãƒ¼ã‚¿ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã€‚
      "Spells": [
        {
          "Name": "Odin: Protective Light",
          "Type": "Summon",
          "Level": 6,
          "Power": null,
          "Accuracy": 100,
          "Price": "-",
          "Value": "-",
          "Target": "All Enemies",
          "Status": "-",
          "Element": "-",
          "Cast By": "Ev"
        },

â‘  Reflect åˆ†å²ã®æ¡ä»¶ã‚’æ‹¡å¼µ
â‘¡ Reflect ãƒ–ãƒ­ãƒƒã‚¯æœ¬ä½“ã‚’å·®ã—æ›¿ãˆ

-----
å¬å–šé­”æ³•"Ifrit: Healing Light"ï¼šå‘³æ–¹å…¨ä½“ã‚’å›å¾©ã€‚
ãªãŠã€Spellsãƒ‡ãƒ¼ã‚¿ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã€‚
      "Spells": [
        {
          "Name": "Ifrit: Healing Light",
          "Type": "Summon",
          "Level": 4,
          "Power": 90,
          "Accuracy": 100,
          "Price": "-",
          "Value": "-",
          "Target": "All Enemies",
          "Status": "-",
          "Element": "Recovery",
          "Cast By": "Ev"
        },

Ifrit: Healing Light ã‚’ã€Œå‘³æ–¹å…¨ä½“å›å¾©ã®å¬å–šé­”æ³•ã€ã¨ã—ã¦æ‰±ã†ãŸã‚ã«ã€
â‘ å¬å–šé­”æ³•ã®ç¨®åˆ¥ã‚’å°‚ç”¨åŒ–(Summon Spell ã‚’ magic_type="summon" ã«ã™ã‚‹)
â‘¡å›å¾©é­”æ³•åˆ¤å®š(healing_spell_kind)ã« Healing Light ã‚’è¿½åŠ 
â‘¢ãƒ­ã‚°ã‚’å¬å–šã£ã½ã(HP å›å¾©ãƒ–ãƒ­ãƒƒã‚¯ã«ã€Œå¬å–šç”¨ãƒ­ã‚°ã€ã‚’è¿½åŠ )
ã¨ã„ã†3ç‚¹ã‚’å…¥ã‚Œã¦ã‚ã’ã‚‹ã¨ãã‚Œã„ã«å‹•ãã¾ã™ã€‚

-----
å¬å–šé­”æ³•"Chocobo: Chocobo Dash"ï¼š50%ã®ç¢ºç‡ã§æˆ¦é—˜ã‹ã‚‰é€ƒã’ã‚‹ã€‚
ãªãŠã€Spellsãƒ‡ãƒ¼ã‚¿ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã€‚
      "Spells": [
        {
          "Name": "Chocobo: Chocobo Dash",
          "Type": "Summon",
          "Level": 1,
          "Power": null,
          "Accuracy": 100,
          "Price": "-",
          "Value": "-",
          "Target": "All Enemies",
          "Status": "-",
          "Element": "-",
          "Cast By": "Ev"
        },

é€šå¸¸æˆ¦é—˜:
MPæ¶ˆè²» â†’ ä¹±æ•° 50% æœªæº€ãªã‚‰
ãƒ­ã‚°:
ãƒ«ãƒ¼ãƒã‚¹ã¯å¬å–šé­”æ³•ã€ŠChocobo: Chocobo Dashã€‹ã‚’å‘¼ã³å‡ºã—ãŸï¼ ãƒãƒ§ã‚³ãƒœã®ãƒ€ãƒƒã‚·ãƒ¥ã§æˆ¦é—˜ã‹ã‚‰é€ƒã’å‡ºã—ãŸï¼ ï¼ˆMP1 x/xï¼‰
Run ã‚³ãƒãƒ³ãƒ‰ã¨åŒæ§˜ã« escaped=True, end_reason="escaped" ã§ã‚¿ãƒ¼ãƒ³çµ‚äº†
å¤±æ•—æ™‚ã¯
ãƒ­ã‚°:
ã—ã‹ã—ãƒãƒ§ã‚³ãƒœã¯é€ƒã’åˆ‡ã‚Œãªã‹ã£ãŸâ€¦
ãƒ€ãƒ¡ãƒ¼ã‚¸ã¯ 0ã€æ•µã®è¡Œå‹•ãƒ•ã‚§ãƒ¼ã‚ºã¸

ãƒœã‚¹æˆ¦ï¼ˆenemy_json["PlotBattles"] çœŸï¼‰:
MPã ã‘æ¶ˆè²»ã—ã¦
ãƒ­ã‚°:
ã—ã‹ã—ã“ã®æˆ¦ã„ã‹ã‚‰ã¯é€ƒã’ã‚‰ã‚Œãªã„ï¼
å½“ç„¶é€ƒèµ°ã¯ç™ºç”Ÿã›ãšã€ãã®ã¾ã¾æ•µã‚¿ãƒ¼ãƒ³ã¸

MPä¸è¶³:
å¬å–šã—ã‚ˆã†ã¨ã—ã¦å¤±æ•—ãƒ­ã‚°ï¼‹ãƒ€ãƒ¡ãƒ¼ã‚¸0ã€æ•µã‚¿ãƒ¼ãƒ³ã¸

-----
å¬å–šé­”æ³•"Chocobo: Chocobo Kick?"ï¼š1ä½“ã®æ•µã«æ”»æ’ƒã™ã‚‹ãŒå¿…ãšå¤–ã‚Œã‚‹ã€‚
ãªãŠã€Spellsãƒ‡ãƒ¼ã‚¿ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã€‚

        {
          "Name": "Chocobo: Chocobo Kick?",
          "Type": "Summon",
          "Level": 1,
          "Power": null,
          "Accuracy": 100,
          "Price": "-",
          "Value": "-",
          "Target": "One Enemy",
          "Status": "-",
          "Element": "-",
          "Cast By": "Ev"
        },

spell_label.endswith("Chocobo Kick?") ã§ã€ŒChocobo: Chocobo Kick?ã€ã‚’åˆ¤å®šï¼ˆæœ«å°¾ã ã‘è¦‹ã‚‹ã®ã§ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãŒå¤‰ã‚ã£ã¦ã‚‚å®‰å¿ƒï¼‰ã€‚
æ—¢ã«ã“ã®æ™‚ç‚¹ã§ MP ã¯æ¶ˆè²»æ¸ˆã¿ ãªã®ã§ã€suffix ã« MP è¡¨ç¤ºãŒå…¥ã£ã¦ã„ã¾ã™ã€‚
dmg_to_enemy = 0 ã®ã¾ã¾ã«ã—ã¦ã‚ã‚‹ã®ã§ã€
ãƒ€ãƒ¡ãƒ¼ã‚¸é©ç”¨éƒ¨åˆ†ã§ã¯ HP å¤‰åŒ–ãªã—
ä¸‹ã®å…±é€šãƒ­ã‚°éƒ¨åˆ†ã‚‚ dmg_to_enemy > 0 ã§ã‚¬ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã®ã§è¿½åŠ ãƒ­ã‚°ã¯å‡ºã¾ã›ã‚“
çŠ¶æ…‹ç•°å¸¸ã¯ apply_status_spell_to_enemy ãŒå‘¼ã°ã‚Œã‚‹ã®ã¯ã€Œé€šå¸¸æ”»æ’ƒé­”æ³•ã€ãƒ–ãƒ­ãƒƒã‚¯ã®ä¸­ã ã‘ãªã®ã§ã€ã“ã®å°‚ç”¨åˆ†å²ã§ã¯ä¸€åˆ‡ä»˜ä¸ã•ã‚Œã¾ã›ã‚“ã€‚

-----
å¬å–šé­”æ³•
MagicPower = SpellPower + Intelligence
MagicMultiplier = (Intelligence/8) + (((JobLevel/8)*3)/2) + 1
MagicAccuracy% = SpellAccuracy% + Intelligence

é­”æ³•æ”»æ’ƒï¼š
ãƒ€ãƒ¡ãƒ¼ã‚¸
Black Magic Power = (Spell Power) + (Intelligence/2)
For offensive White spells (Holy, Aeroga, Aero):
White Magic Power = (Spell Power) + (Mind/2)
For non-offensive White spells (Cureja, Curega, Cura, Cure, Haste, Protect):
White Magic Power = (Spell Power) 
Call Magic Power = (Spell Damage) + (Intelligence)

å€ç‡
Black Magic Multiplier = (Intelligence/16) + (Level/16) + (JobLevel/32) + 1
White Magic Multiplier = (Spirit/16) + (Level/16) + (JobLevel/32) + 1
Call Magic Multiplier = (Intelligence/8) + (((JobLevel/8)*3)/2) + 1

å‘½ä¸­ç‡
Black Magic Accuracy% = (Spell Accuracy%) + (Intelligence/2)
White Magic Accuracy% = (Spell Accuracy%) + (Mind/2)
Call Magic Accuracy% = (Spell Accuracy%) + (Intelligence)

ã‚¢ã‚¤ãƒ†ãƒ ï¼š
Powerè¨ˆç®—ã¯"BasePower"ã‚’é©ç”¨ã—ã€é­”æ³•æ”»æ’ƒã¨åŒã˜æ–¹æ³•ã§è¡Œã†
Magic Multiplierã¯ã‚¢ã‚¤ãƒ†ãƒ ã«è¨­å®šã•ã‚ŒãŸ"Multiplier"ã‚’é©ç”¨ï¼ˆä½¿ç”¨è€…ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«ä¾å­˜ã—ãªã„ã€å¤§éƒ¨åˆ†ã¯3ï¼‰
Magic Accuracyã¯100%ï¼ˆä½¿ç”¨è€…ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«ä¾å­˜ã—ãªã„ã€Blindã«ã‚‚å½±éŸ¿ã•ã‚Œãªã„ï¼‰


-----------
ã„ã¾ã®ã‚³ãƒ¼ãƒ‰ã§ã®ãƒ€ãƒ¡ãƒ¼ã‚¸å¼ï¼ˆé‡è¦éƒ¨åˆ†ï¼‰

magic_damage_char_to_enemy() ã¯ã“ã†ã„ã†æµã‚Œã§ã™ï¼š
1. magic_power / magic_mult / magic_acc ã‚’è¨ˆç®—
2. _calc_expected_magic_hits() ã§ å¹³å‡ãƒ’ãƒƒãƒˆæ•°ï¼ˆæœŸå¾…å€¤ï¼‰ ã‚’å‡ºã™
3. _calc_base_magic_damage_per_hit() ã§ 1ãƒ’ãƒƒãƒˆã‚ãŸã‚ŠåŸºç¤ãƒ€ãƒ¡ ã‚’å‡ºã™
4. base_per_hit * expected_hits ãŒãƒ€ãƒ¡ãƒ¼ã‚¸ 

expected_hits = _calc_expected_magic_hits(
    magic_mult=magic_mult,
    magic_acc_percent=magic_acc,
    mdef_mult=enemy.magic_def_multiplier,
    magic_resistance_percent=enemy.magic_resistance_percent,
)
base_per_hit = _calc_base_magic_damage_per_hit(...)
dmg = base_per_hit * expected_hits

_calc_expected_magic_hits() ã¯
expected = magic_mult * hit_rate - mdef_mult * resist_rate
ã¨ã„ã† â€œæœŸå¾…å€¤ã®ã¾ã¾â€è¨ˆç®—ã™ã‚‹å¼ã«ãªã£ã¦ã„ã¾ã™ã€‚
-----------


ã‚¢ã‚¤ãƒ†ãƒ ã®Accuracyï¼š100%ï¼ˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«ä¾å­˜ã—ãªã„ï¼‰


-----------
ç›—è³Š"ç›—ã‚€"Steal
æˆåŠŸç‡ï¼š
Steal Rate% = level/3% + job_level/3%
æˆåŠŸã—ãŸã‚‰æ•µ JSON ã® "Stolen Items" ã‹ã‚‰ã‚¢ã‚¤ãƒ†ãƒ ã‚’æŠ½é¸ã—ã€save["inventory"] ã« 1å€‹ è¿½åŠ ã™ã‚‹ã€‚

-----------
ç›—è³Š"ã¨ã‚“ãšã‚‰"Flee
ãƒœã‚¹ä»¥å¤–ã‹ã‚‰100%é€ƒã’å‡ºã™

-----------
å­¦è€…"ã¿ã‚„ã¶ã‚‹"Peep
æ•µã®"ElementalVulnerability"ã‚’ç¢ºèªã™ã‚‹
"Weakness"ã€"Absorb"ã€"Resistance"ã«ãªã‚‹å±æ€§ãŒã‚ã‚Œã°ã€ãƒ­ã‚°ã¨ã—ã¦è¡¨ç¤º

-----------
å­¦è€…"ã—ã‚‰ã¹ã‚‹"Study
å¯¾è±¡ã®ç¾åœ¨ HP / æœ€å¤§ HP ã‚’ãƒ­ã‚°ã«å‡ºã™ã ã‘ï¼ˆãƒ€ãƒ¡ãƒ¼ã‚¸ãªã—ï¼‰

-----------
é¢¨æ°´å¸«"ã¡ã‘ã„"Terrain
Magic Damage = BasePower + (Intelligence/2)
Magic Hit% = BaseAccuracy% + (Intelligence/2)
Magic Attack Multiplier = (Intelligence/16) + (Level/16) + (Job_Level/32) + 1
æ•µã«ãƒ’ãƒƒãƒˆã—ãªã‹ã£ãŸã¨ãã¯"Backfired"ãŒç™ºå‹•ã—ã€æœ€å¤§hp/4ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ã‚‹ã€‚

æˆ¦é—˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å¿œã˜ã¦ã€Cave Inç­‰ã®SpellsãŒç™ºå‹•ã™ã‚‹ã€‚Spellsã¨æˆ¦é—˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®é–¢ä¿‚ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã€‚
Cyclone: Sky
Earthquake: Grassland (All Enemy)
Quicksand: Desert, KO
Sinkhole: Marsh, KO
Torrent: River, KO
Whirlpool: Ocean (All Enemy)
Wind Slash: Forest
Cave In: Other (All Enemy)

å„Spellsã®ãƒ‡ãƒ¼ã‚¿ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã€‚
    {
      "name": "Cyclone",
      "Type": "Terrain Effect (Black Magic)",
      "BaseTerrain": "Sky",
      "Level": 1,
      "Effect": "Deal Air damage",
      "Element": "Air",
      "BasePower": 120,
      "BaseAccuracy": 0.6,
      "Reflectable": "No",
      "Target": "One Enemy",
      "CastBy": [
        "Ge"
      ]
    },
    {
      "name": "Earthquake",
      "Type": "Black Magic (used only by monsters)",
      "Level": 7,
      "Effect": "Deal Earth damage",
      "Element": "Earth",
      "BasePower": 80,
      "BaseAccuracy": 1.0,
      "Reflectable": "No",
      "Target": "All Enemies"
    },
    {
      "name": "Quicksand",
      "Type": "Terrain Effect (Black Magic)",
      "BaseTerrain": "Desert",
      "Level": 1,
      "Effect": "Inflict KO",
      "StatusAilment": "KO",
      "BasePower": 0,
      "BaseAccuracy": 0.3,
      "Reflectable": "No",
      "Target": "One Enemy",
      "CastBy": [
        "Ge"
      ]
    },
    {
      "name": "Sinkhole",
      "Type": "Terrain Effect (Black Magic)",
      "BaseTerrain": "Marsh",
      "Level": 1,
      "Effect": "Inflict KO",
      "StatusAilment": "KO",
      "BasePower": 0,
      "BaseAccuracy": 0.4,
      "Reflectable": "No",
      "Target": "One Enemy",
      "CastBy": [
        "Ge"
      ],
      "Maps": [
        "Bahamut's Lair B2"
      ]
    },
    {
      "name": "Torrent",
      "Type": "Terrain Effect (Black Magic)",
      "BaseTerrain": "River",
      "Level": 1,
      "Effect": "Inflict KO",
      "Element": "Lightning",
      "StatusAilment": "KO",
      "BasePower": 0,
      "BaseAccuracy": 0.4,
      "Reflectable": "No",
      "Target": "One Enemy",
      "CastBy": [
        "Ge"
      ],
    },
    {
      "name": "Whirlpool",
      "Type": "Terrain Effect (Black Magic)",
      "BaseTerrain": "Ocean",
      "Level": 1,
      "Effect": "Deal Air damage",
      "Element": "Air",
      "BasePower": 120,
      "BaseAccuracy": 0.6,
      "Reflectable": "No",
      "Target": "All Enemies",
      "CastBy": [
        "Ge"
      ],
    },
    {
      "name": "Wind Slash",
      "Type": "Terrain Effect (Black Magic)",
      "BaseTerrain": "Forest",
      "Level": 1,
      "Effect": "Deal Air damage",
      "Element": "Air",
      "BasePower": 120,
      "BaseAccuracy": 0.3,
      "Reflectable": "No",
      "Target": "One Enemy",
      "CastBy": [
        "Ge"
      ],
    },
    {
      "name": "Cave In",
      "Type": "Terrain Effect (Black Magic)",
      "Level": 1,
      "Effect": "Deal Earth damage",
      "Element": "Earth",
      "BasePower": 120,
      "BaseAccuracy": 0.4,
      "Reflectable": "No",
      "Target": "All Enemies",
      "CastBy": [
        "Ge"
      ],
      "Maps": [
        "Dragon's Peak",
        "Doga's Grotto B3"
      ]
    }

-----------
ã‚¸ãƒ§ãƒ–"Dragoon"ã®ã‚³ãƒãƒ³ãƒ‰"BattleCommand2"ã§ã‚ã‚‹"Jump"ã‚’ä»¥ä¸‹ã®ä»•æ§˜ã§æ·»ä»˜ã®ff3_calc.pyã«å®Ÿè£…ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¯ã€"Jump"ã‚’ä½¿ç”¨ã—ãŸã‚¿ãƒ¼ãƒ³ã¯ä¸Šç©ºã«èˆã„ä¸ŠãŒã£ã¦ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãªããªã‚Šã€æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã«æ”»æ’ƒã‚’è¡Œã£ãŸå¾Œæˆ¦é—˜ã«å¾©å¸°ã—ã¾ã™ã€‚

"Jump"ã‚’ä½¿ç”¨ã—ãŸã‚¿ãƒ¼ãƒ³ï¼šæ•µã‹ã‚‰ã®ç‰©ç†æ”»æ’ƒãƒ»é­”æ³•æ”»æ’ƒã®Hit% = 0 ã¨ã™ã‚‹ï¼ˆæ”»æ’ƒã«ã‚ˆã‚‹ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãªã„ã€‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹çŠ¶æ…‹ã¯ç¶­æŒã€‚Poisonãƒ€ãƒ¡ãƒ¼ã‚¸ã¯å—ã‘ã‚‹ã€‚ï¼‰
"Jump"ã‚’ä½¿ç”¨ã—ãŸæ¬¡ã®ã‚¿ãƒ¼ãƒ³ï¼šä»¥ä¸‹ã®è¨ˆç®—å¼ã§æ”»æ’ƒã‚’è¡Œã„æˆ¦é—˜ã«å¾©å¸°ã€‚æ•µã‹ã‚‰ã®æ”»æ’ƒå¯¾è±¡ã¨ãªã‚Šã€å¾©å¸°å¾Œã¯é€šå¸¸é€šã‚Šãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ã‚‹ã€‚

Attack Damage = ((Weapon Damage) + (Strength/4)) * 3
Attack Multiplier = (Agility/16) + (Level/16) + 1
Hit% = (Weapon Hit%) + (Agility/4) + (Job_Level/4)

///////////
ã‚³ãƒ¼ãƒ‰ã‚’ã”æç¤ºã—ã‚ˆã†ã¨ã—ãŸã®ã§ã™ãŒã€ff3_calc.py ãŒã‹ãªã‚Šå¤§ããã€BattleCommand2 ã‚„ Jump ãŒã©ã®éƒ¨åˆ†ã«å®Ÿè£…ã•ã‚Œã‚‹æ§‹é€ ãªã®ã‹ãŒã¾ã èª­ã¿åˆ‡ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
ï¼ˆï¼ãƒ•ã‚¡ã‚¤ãƒ«å†…ã« BattleCommand2 / Jump ãŒè¦‹å½“ãŸã‚‰ãªã„ãŸã‚ã€æ­£ç¢ºã«çµ„ã¿è¾¼ã‚€ã«ã¯ è©²å½“ã‚¯ãƒ©ã‚¹å®šç¾©éƒ¨åˆ† ã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼‰

ğŸ”§ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ— â€” è©²å½“éƒ¨åˆ†ã‚’æ•™ãˆã¦ãã ã•ã„
ä»¥ä¸‹ã®ã©ã‚Œã‹ã‚’é€ã£ã¦ã„ãŸã ã‘ã‚Œã°ã€Jump ã®å®Œå…¨ãªã‚³ãƒ¼ãƒ‰ã‚’ ã‚ãªãŸã® ff3_calc.py ã®æ§‹é€ ã«åˆã‚ã›ã¦ å®Ÿè£…ã—ã¾ã™ã€‚

ğŸ“Œ é€ã£ã¦ã»ã—ã„éƒ¨åˆ†
1. BattleCommand / BattleCommand2 ã®ã‚¯ãƒ©ã‚¹å®šç¾©éƒ¨åˆ†
2. Dragoon ã®ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œå‡¦ç† (command dispatch) ãŒæ›¸ã‹ã‚Œã¦ã„ã‚‹éƒ¨åˆ†
3. æ”»æ’ƒè¨ˆç®—ï¼ˆé€šå¸¸æ”»æ’ƒï¼‰ã‚’è¡Œã£ã¦ã„ã‚‹é–¢æ•°ï¼ˆJump ã®ç€åœ°æ”»æ’ƒã§æµç”¨ã—ãŸã„ï¼‰

âœ¨ ä»Šã§ãã‚‹ã“ã¨ï¼šJump å®Ÿè£…ã®â€œå®Œæˆç‰ˆãƒ­ã‚¸ãƒƒã‚¯â€
ã‚ãªãŸã®ä»•æ§˜ã«åŸºã¥ã„ã¦ã€Jump ã®å‹•ä½œã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼š

ä»•æ§˜ã®æ•´ç†ï¼ˆä»Šå›ã®ã‚´ãƒ¼ãƒ«ï¼‰

Turn N ã§ Jump ã‚³ãƒãƒ³ãƒ‰ã‚’é¸ã¶
â†’ ä¸Šç©ºã«é£›ã¶
â†’ ã“ã®ã‚¿ãƒ¼ãƒ³ã¯æ•µã®æ”»æ’ƒãŒä¸€åˆ‡å½“ãŸã‚‰ãªã„ï¼ˆPoisonãƒ€ãƒ¡ãƒ¼ã‚¸ã ã‘ã¯å—ã‘ã‚‹ï¼‰
â†’ ã‚¸ãƒ£ãƒ³ãƒ—ãƒ•ãƒ©ã‚° is_jumping = True

Turn N+1
â†’ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒä½•ã‚’å…¥åŠ›ã—ã‚ˆã†ãŒç„¡è¦–ã—ã¦
å¼·åˆ¶çš„ã«ã€Œã‚¸ãƒ£ãƒ³ãƒ—ç€åœ°æ”»æ’ƒã€ã‚’å®Ÿè¡Œ
â†’ ãã®ã‚ã¨ æ•µã‚¿ãƒ¼ãƒ³ã¯é€šå¸¸ã©ãŠã‚Šè¡Œã†
â†’ is_jumping = False ã«æˆ»ã‚‹

ã•ã‚‰ã«
ã‚¸ãƒ£ãƒ³ãƒ—æ”»æ’ƒã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã¯æŒ‡å®šå¼ã§è¨ˆç®—ï¼š

Attack Damage = ((Weapon Damage) + (Strength/4)) * 3
Attack Multiplier = (Agility/16) + (Level/16) + 1
Hit% = (Weapon Hit%) + (Agility/4) + (Job_Level/4)

ã“ã“ã§
Weapon Damage = main_power ã¾ãŸã¯ off_power
Weapon Hit% = main_accuracy ã¾ãŸã¯ off_accuracy
ã¨è§£é‡ˆã—ã¾ã™ã€‚


BattleActorState ã«ã‚¸ãƒ£ãƒ³ãƒ—çŠ¶æ…‹ãƒ•ãƒ©ã‚°ã‚’è¿½åŠ 
ã€Œã‚¸ãƒ£ãƒ³ãƒ—ç€åœ°æ”»æ’ƒã€ã‚’ã‚­ãƒ£ãƒ©è¡Œå‹•ã®ä¸€ç•ªæœ€åˆã«æŒ¿å…¥
special ãƒ–ãƒ­ãƒƒã‚¯å†…ã®ã€ŒDragoon: Jumpã€ã‚’â€œä¸Šæ˜‡ã ã‘â€ã«ã™ã‚‹
æ•µã‚¿ãƒ¼ãƒ³å´ã«ã€Œã‚¸ãƒ£ãƒ³ãƒ—ä¸­ã¯æ”»æ’ƒç„¡åŠ¹ã€ã‚’å…¥ã‚Œã‚‹ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

ã“ã‚Œã§æœŸå¾…ã•ã‚Œã‚‹ãƒ­ã‚°ã‚¤ãƒ¡ãƒ¼ã‚¸
Turn 1ï¼ˆJump é¸æŠï¼‰
ãƒ«ãƒ¼ãƒã‚¹ã¯ã‚¸ãƒ£ãƒ³ãƒ—ã—ãŸï¼æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã«æ”»æ’ƒã™ã‚‹ã€‚
ï¼ˆæ•µã‚¿ãƒ¼ãƒ³ç„¡ã—ï¼‰

Turn 2ï¼ˆã‚³ãƒãƒ³ãƒ‰ã¯ Fight ã ã‚ã†ãŒ Defend ã ã‚ã†ãŒç„¡è¦–ï¼‰
ãƒ«ãƒ¼ãƒã‚¹ã¯ç©ºã‹ã‚‰é™ä¸‹æ”»æ’ƒï¼ Gutscoã«XXXã®ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼ï¼ˆGutsco æ®‹ã‚ŠHP: ...ï¼‰
ï¼ˆã“ã®ã‚ã¨ã€é€šå¸¸é€šã‚Š Gutsco ã®ã‚¿ãƒ¼ãƒ³ï¼‰

ä»¥é™ã¯æ™®é€šã®è¡Œå‹•ã«æˆ»ã‚Šã¾ã™ã€‚
///////////////
Prompt:
ã‚¸ãƒ§ãƒ–"Black Belt"ã®ã‚³ãƒãƒ³ãƒ‰"BattleCommand2"ã§ã‚ã‚‹"Boost"ã‚’ä»¥ä¸‹ã®ä»•æ§˜ã§å®Ÿè£…ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

Boost ã‚’1å›ä½¿ç”¨: Attack Damage = ((Weapon Damage) + (Strength/4)) * 2ã€‚defenceã€defence multiplierã€magic defenceãŒ0ã«ãªã‚‹ã€‚
Boost ã‚’2å›ä½¿ç”¨: Attack Damage = ((Weapon Damage) + (Strength/4)) * 3ã€‚defenceã€defence multiplierã€magic defenceãŒ0ã«ãªã‚‹ã€‚
Boost ã‚’3å›ä½¿ç”¨: "Overload"ãŒç™ºç”Ÿã€‚Attack Damage = 0ã€‚ç¾åœ¨ã®hpã®åŠåˆ†ã‚’å¤±ã†ã¨ã¨ã‚‚ã«ã€BooståŠ¹æœã‚’å¤±ã†ã€‚

Attack Multiplier = (Agility/16) + (Level/16) + 1
Hit% = (Weapon Hit%) + (Agility/4) + (Job_Level/4)

ff3_calc.py ã®å¿…è¦ãªç®‡æ‰€ãŒã‚ã‚Œã°æŠœç²‹ã—ã¦æä¾›ã™ã‚‹ã®ã§ã€æ•™ãˆã¦ãã ã•ã„ã€‚

è¨­è¨ˆ:
Boost 1å› â†’ æ”»æ’ƒåŠ› Ã—2 / é˜²å¾¡0 / é­”é˜²0
Boost 2å› â†’ æ”»æ’ƒåŠ› Ã—3 / é˜²å¾¡0 / é­”é˜²0
Boost 3å› â†’ Overload ç™ºç”Ÿ
           â†’ æ”»æ’ƒãƒ€ãƒ¡ãƒ¼ã‚¸0
           â†’ ç¾åœ¨HPã®50%æ¸›å°‘
           â†’ boost_count = 0 ã«ãƒªã‚»ãƒƒãƒˆ
ã¤ã¾ã‚Šï¼š
âœ… Boost ã¯ å³æ™‚æ”»æ’ƒã§ã¯ãªãã€Œæ¬¡å›æ”»æ’ƒå¼·åŒ–ãƒãƒ•ã€
âœ… Defend ã¨åŒã˜ã temp_flags + æ°¸ç¶šã‚«ã‚¦ãƒ³ã‚¿ä½µç”¨
âœ… 3å›ç›®ã¯ è‡ªå·±ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼‹å¼·åŒ–è§£é™¤

-----------
åŸéŠè©©äºº
Prompt:
ã‚¸ãƒ§ãƒ–"Bard"ã®ã‚³ãƒãƒ³ãƒ‰"BattleCommand1"ã§ã‚ã‚‹"Sing"ã‚’ä»¥ä¸‹ã®ä»•æ§˜ã§å®Ÿè£…ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

ã‚³ãƒãƒ³ãƒ‰"Sing"ã‚’ å†…éƒ¨çš„ã«"Fight"ã¨åŒã˜æ‰±ã„ã«ã™ã‚‹

ff3_calc.py ã®å¿…è¦ãªç®‡æ‰€ãŒã‚ã‚Œã°æŠœç²‹ã—ã¦æä¾›ã™ã‚‹ã®ã§ã€æ•™ãˆã¦ãã ã•ã„ã€‚

///////////////
â€ãŠã©ã‹ã™â€Scare
ã‚¸ãƒ§ãƒ–"Bard"ã®ã‚³ãƒãƒ³ãƒ‰"BattleCommand2"ã§ã‚ã‚‹"Scare"ã‚’ä»¥ä¸‹ã®ä»•æ§˜ã§å®Ÿè£…ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

æ•µã®ãƒ¬ãƒ™ãƒ«ã‚’3ä¸‹ã’ã‚‹ã€‚åŠ¹æœã¯ç´¯ç©å¯èƒ½ã€‚

ff3_calc.py ã®å¿…è¦ãªç®‡æ‰€ãŒã‚ã‚Œã°æŠœç²‹ã—ã¦æä¾›ã™ã‚‹ã®ã§ã€æ•™ãˆã¦ãã ã•ã„ã€‚

////
ãƒœã‚¹ä»¥å¤–ã®æ•µãŒé€ƒã’ã‚ˆã†ã¨ã™ã‚‹ã®ã¯ä»¥ä¸‹ã®å ´åˆ
(Lowest character level) - (Enemy level) > 15
æ•µãŒé€ƒã’å‡ºã™ç¢ºç‡ã¯
Chance to run% = 100 - Monster hit%

ã‚ãªãŸã®ã‚³ãƒ¼ãƒ‰æ§‹é€ ã ã¨ã€
å‘³æ–¹å´ã¯ char_stats: FinalCharacterStatsï¼ˆï¼1äººæƒ³å®šï¼‰
æ•µå´ã¯ enemy_stats: FinalEnemyStats
å‘³æ–¹ãƒ¬ãƒ™ãƒ« â†’ char_stats.level
æ•µãƒ¬ãƒ™ãƒ« â†’ enemy_stats.levelï¼ˆâ† Scare ã§ä¸‹ã’ãŸã‚„ã¤ï¼‰
Monster hit% â†’ enemy_stats.accuracy_percentï¼ˆcompute_enemy_final_stats ã§ 0ã€œ100 ã«ã—ã¦ã„ã‚‹ï¼‰
ãªã®ã§ã€ãã®ã¾ã¾ã“ã®å¼ã«å½“ã¦ã¯ã‚ã¦å®Ÿè£…ã§ãã¾ã™ã€‚

-----------
â€œãŠã†ãˆã‚“â€Cheer
ã‚¸ãƒ§ãƒ–"Bard"ã®ã‚³ãƒãƒ³ãƒ‰"BattleCommand3"ã§ã‚ã‚‹"Cheer"ã‚’ä»¥ä¸‹ã®ä»•æ§˜ã§å®Ÿè£…ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¡ãƒ³ãƒãƒ¼ã®ç‰©ç†æ”»æ’ƒåŠ›ã‚’ä¸Šã’ã‚‹ã€‚åŠ¹æœã¯ç´¯ç©å¯èƒ½ã€‚
Base damage = Base damage + 10

BattleActorState.cheer_bonus ã§ æˆ¦é—˜ä¸­ã®ã¿ç´¯ç©
"Cheer" å®Ÿè¡Œã”ã¨ã« ç‰©ç†æ”»æ’ƒåŠ›ã‚’10ä¸Šæ˜‡ã•ã›ã‚‹

-----------

-----------




å˜ä½“çš„ã¸ã®æ”»æ’ƒã®å¯¾è±¡ã‚’è¤‡æ•°ã®æ•µã«ã—ãŸå ´åˆï¼šæœ€çµ‚ãƒ€ãƒ¡ãƒ¼ã‚¸=æœ€çµ‚ãƒ€ãƒ¡ãƒ¼ã‚¸/å¯¾è±¡ã¨ã™ã‚‹æ•µã®æ•°



3) special ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè£…å„ªå…ˆåº¦
Evoker ã ã¨æ¬¡ã¯ã€ŒSummon ã®ãƒ©ãƒ³ãƒ€ãƒ åŠ¹æœï¼ˆç™½/é»’ã©ã£ã¡ãŒå‡ºã‚‹ã‹ï¼‰ã€ãŒé¢ç™½ãƒã‚¤ãƒ³ãƒˆãªã®ã§ã€
special â†’ ã‚¸ãƒ§ãƒ–åˆ¥ãƒãƒ³ãƒ‰ãƒ©ã€ã®æ ã‚’ä½œã£ã¦ã„ãã¨æ¥½ã—ãä¼¸ã°ã›ã¾ã™ã€‚
ã¾ãŸæŒ™å‹•è¿½åŠ ã—ãŸããªã£ãŸã‚‰ã€ã©ã®ã‚³ãƒãƒ³ãƒ‰ã‹ã‚‰å®Ÿè£…ã™ã‚‹ã‹ä¸€ç·’ã«æ±ºã‚ã‚ˆã€œã€‚

â–  æ•µã®ã™ã°ã‚„ã•ã®ä»£ã‚ã‚Šã«å›é¿ç‡ã‚’åˆ©ç”¨
elif char_attack_kind == "run":
    # é€ƒèµ°ï¼šç°¡æ˜“åˆ¤å®š
    # FinalCharacterStats ã¯ agility å±æ€§
    char_agi = char_stats.agility
    # FinalEnemyStats ã«ã¯æ•æ·ãŒç„¡ã„ã®ã§ã€é€ƒã’ã«ãã•ã®ä»£ç†ã¨ã—ã¦å›é¿ç‡ã‚’åˆ©ç”¨ï¼ˆå®‰å…¨ã«å‹•ãç°¡æ˜“å¼ï¼‰
    enemy_weight = max(1.0, float(enemy_stats.evasion_percent))  # 0é™¤ç®—ã‚¬ãƒ¼ãƒ‰
    escape_chance = min(
        0.95,
        max(0.05, char_agi / (char_agi + enemy_weight))
    )


ã€Anywhereã€‘
  Restoreï¼ˆå›å¾©ï¼‰: 1: Elixir, 2: Hi Potion, 3: Potion
  Reviveï¼ˆè˜‡ç”Ÿï¼‰: 4: Phoenix Down
  Cureï¼ˆæ²»ç™‚ï¼‰: 5: Antidote, 6: Echo Herbs,, 7: Eye Drops, 8: Gold Needle, 9: Maiden's Kiss, 10: Mallet
ã€Combatã€‘
  Damageï¼ˆæ”»æ’ƒï¼‰: 11: Bomb Arm, 12: Antarctic Wind, 13: Arctic Wind, 14: Zeus's Wrath, 15: Heavenly Wrath, 16: Raven's Yawn, 17: Earthen Drums, 18: Chocobo's Wrath, 19: White Musk
  Inflictï¼ˆçŠ¶æ…‹ç•°å¸¸ï¼‰: 20: Black Hole, 21: Black Musk, 22: Devil's Sigh, 23: Lamia Scale, 24: Sheep Pillow, 25: Tranquilizer
  Supportï¼ˆè£œåŠ©/ãã®ä»–ï¼‰: 26: Bacchus's Cider, 27: Lilith's Kiss, 28: Shining Curtain, 29: Turtle Shell


å„ç¨®çŠ¶æ…‹ç•°å¸¸ã«ã¤ã„ã¦ã€ä¸€éƒ¨å®Ÿè£…ã—ã‹ã‘ã¦ã„ã¾ã™ãŒã€ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã§æˆ¦é—˜çŠ¶æ…‹ã«åæ˜ ã™ã‚‹ã‚ˆã†ã«ã€æ·»ä»˜ã®ff3_calc.pyã€å®Ÿè¡Œæ™‚ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

"Poison":
Type Parmanentï¼ˆæˆ¦é—˜ãŒçµ‚ã‚ã£ã¦ã‚‚ç¶™ç¶šã™ã‚‹ï¼‰
ãƒ»æˆ¦é—˜ä¸­ã¯1ã‚¿ãƒ¼ãƒ³ã«1/16ã®hpã‚’å¤±ã†
ãƒ»ç§»å‹•ä¸­ã¯1æ­©æ¯ã«1ã®hpã‚’å¤±ã†

"Blind":
Type Parmanentï¼ˆæˆ¦é—˜ãŒçµ‚ã‚ã£ã¦ã‚‚ç¶™ç¶šã™ã‚‹ï¼‰
ãƒ»ç‰©ç†æ”»æ’ƒã¨é­”æ³•æ”»æ’ƒã®å‘½ä¸­ç‡ãŒåŠæ¸›ã™ã‚‹

"Mini":
Type Parmanentï¼ˆæˆ¦é—˜ãŒçµ‚ã‚ã£ã¦ã‚‚ç¶™ç¶šã™ã‚‹ï¼‰
ãƒ»ç‰©ç†æ”»æ’ƒåŠ›ãŒ0ã«ã€ç‰©ç†é˜²å¾¡åŠ›ã¨é­”æ³•é˜²å¾¡åŠ›ãŒ0ã«ãªã‚‹

"Silence":
Type Parmanentï¼ˆæˆ¦é—˜ãŒçµ‚ã‚ã£ã¦ã‚‚ç¶™ç¶šã™ã‚‹ï¼‰
ãƒ»Spellsã€Special AttacksãŒä½¿ãˆãªããªã‚‹

"Toad":
Type Parmanentï¼ˆæˆ¦é—˜ãŒçµ‚ã‚ã£ã¦ã‚‚ç¶™ç¶šã™ã‚‹ï¼‰
ãƒ»ç‰©ç†æ”»æ’ƒåŠ›ãŒ0ã«ã€ç‰©ç†é˜²å¾¡åŠ›ã¨é­”æ³•é˜²å¾¡åŠ›ãŒ0ã«ãªã‚‹

"Petrification":
Type Parmanentï¼ˆæˆ¦é—˜ãŒçµ‚ã‚ã£ã¦ã‚‚ç¶™ç¶šã™ã‚‹ï¼‰
ãƒ»æˆ¦é—˜ã‚’é›¢è„±ï¼ˆè¡Œå‹•ãŒã§ããªããªã‚Šã€æ”»æ’ƒã®å¯¾è±¡ã«ã‚‚ãªã‚‰ãªããªã‚‹ï¼‰

"KO":
Type Parmanentï¼ˆæˆ¦é—˜ãŒçµ‚ã‚ã£ã¦ã‚‚ç¶™ç¶šã™ã‚‹ï¼‰
ãƒ»hpãŒ0ã«ãªã‚‹ã¨ç™ºå‹•
ãƒ»å…ˆé ­ã‹ã‚‰é›¢è„±ï¼ˆè¡Œå‹•ãŒã§ããªããªã‚Šã€æ”»æ’ƒã®å¯¾è±¡ã«ã‚‚ãªã‚‰ãªããªã‚‹ï¼‰

"Confusion":
Type Temporaryï¼ˆæˆ¦é—˜å¾Œè§£é™¤ã•ã‚Œã‚‹ï¼‰
ãƒ»ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¡ãƒ³ãƒãƒ¼ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã§æ”»æ’ƒã™ã‚‹
ãƒ»ç‰©ç†æ”»æ’ƒã‚’å—ã‘ã‚‹ã¨è§£é™¤ã•ã‚Œã‚‹

"Sleep":
Type Temporaryï¼ˆæˆ¦é—˜å¾Œè§£é™¤ã•ã‚Œã‚‹ï¼‰
ãƒ»è¡Œå‹•ãŒã§ããªããªã‚‹
ãƒ»ç‰©ç†æ”»æ’ƒã‚’å—ã‘ã‚‹ã¨è§£é™¤ã•ã‚Œã‚‹

"Paralysis":
Type Temporaryï¼ˆæˆ¦é—˜å¾Œè§£é™¤ã•ã‚Œã‚‹ï¼‰
ãƒ»è¡Œå‹•ãŒã§ããªããªã‚‹

"Partial Petrification":
Type Temporaryï¼ˆæˆ¦é—˜å¾Œè§£é™¤ã•ã‚Œã‚‹ï¼‰
ãƒ»å®Œå…¨ã«çŸ³åŒ–ã™ã‚‹ã¾ã§ã¯å½±éŸ¿ãŒãªã„
ãƒ»ç´¯ç©ã—ã¦1ã«ãªã‚Œã°çŸ³åŒ–ã™ã‚‹


"Partial Petrification"ã«ã¯ã€
"Partial Petrification (1/3)"
"Partial Petrification (1/2)"
"Partial Petrification (Full)"
ã®ï¼“ç¨®ãŒã‚ã‚Šã¾ã™ãŒã€
"Partial Petrification (1/3)"=1/3
"Partial Petrification (1/2)"=1/2
"Partial Petrification (Full)"=1
ã¨ã—ã¦ã€ç´¯ç©ãŒï¼‘ã«ãªã£ãŸã¨ãã«ã€"Petrification"=true ã¨ã—ã¦å‡¦ç†ã™ã‚‹ã‚ˆã†ã«ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚
ã“ã®ã‚ˆã†ãªå‡¦ç†ã‚’å®Ÿè£…ã§ãã¾ã™ã‹ã€‚

ç¾åœ¨ã®ff3_calc.pyã‚’æ·»ä»˜ã—ã€å®Ÿè¡Œã‚³ãƒ¼ãƒ‰ã‚’ä¸‹è¨˜ã—ã¾ã™ã€‚

ï¼œå®Ÿè¡Œæ™‚ã‚³ãƒ¼ãƒ‰ï¼
from __future__ import annotations

import json
import random
from dataclasses import dataclass
from pathlib import Path
from typing import Optional, Literal, Dict, Any, Tuple, List, Iterable
from collections import defaultdict
from importlib import reload

import ff3_calc
reload(ff3_calc)

from ff3_calc import (
    load_monsters, load_weapons, load_armors, load_spells, load_items,
    BaseCharacter, EquipmentSet,
    compute_character_final_stats, compute_enemy_final_stats,
    physical_damage_char_to_enemy, element_relation_for_attack,
    weapon_stats, spell_from_json, magic_damage_char_to_enemy,
    BattleActorState, Status, print_magic_menu_by_level,
    expand_spells_for_summons,  # â˜… å¬å–šå±•é–‹
    allowed_spell_names_for_job,
    character_from_party_entry, build_item_list, is_item_visible_in_context,
)

# --- ã“ã“ã‹ã‚‰è¿½åŠ : é­”æ³•ä¸€è¦§ã¨é¸æŠãƒ¡ãƒ‹ãƒ¥ãƒ¼ ---
def build_magic_list(
    spells_by_name: Dict[str, Dict[str, Any]],
    *,
    allowed_names: Optional[Iterable[str]] = None,
    cast_code: Optional[str] = None,
) -> List[Tuple[str, str, int]]:

    allowed_set = set(allowed_names) if allowed_names is not None else None

    lst: List[Tuple[str, str, int]] = []
    for name, s in spells_by_name.items():

        if allowed_set is not None and name not in allowed_set:
            continue

        if cast_code is not None:
            cast_by = s.get("CastBy")
            if cast_by:
                if isinstance(cast_by, str):
                    ok = cast_code in [c.strip() for c in cast_by.split(",")]
                elif isinstance(cast_by, list):
                    ok = cast_code in cast_by
                else:
                    ok = False
                if not ok:
                    continue

        t = s.get("Type", "")
        if t not in ("Black Magic", "White Magic", "Summon Magic", "Summon"):
            continue

        level = int(s.get("Level", 0) or 0)

        # å­å¬å–š(Type="Summon")ã‚‚ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸Šã¯ Summon Magic è¡¨ç¤ºã«å¯„ã›ã‚‹
        if t == "Summon":
            t = "Summon Magic"

        lst.append((name, t, level))

    type_order = {"Black Magic": 0, "White Magic": 1, "Summon Magic": 2}
    lst.sort(key=lambda x: (type_order.get(x[1], 99), x[2], x[0]))
    return lst


def choose_magic(char_state: BattleActorState) -> str:
    """
    MAGIC_LIST ã‹ã‚‰ç•ªå·ã§é­”æ³•ã‚’é¸ã°ã›ã¦ã€Œé­”æ³•åã€ã‚’è¿”ã™ã€‚
    è¡¨ç¤ºã¯ Lvåˆ¥ã¾ã¨ã‚å½¢å¼ã€‚
    """
    if not MAGIC_LIST:
        print("ä½¿ç”¨å¯èƒ½ãªé­”æ³•ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
        return ""

    print("ä½¿ç”¨ã™ã‚‹é­”æ³•ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚")
    print_magic_menu_by_level(MAGIC_LIST, char_state)

    while True:
        s = input(f"ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (1-{len(MAGIC_LIST)}): ").strip()
        if s.isdigit():
            n = int(s)
            if 1 <= n <= len(MAGIC_LIST):
                spell_name, _, _ = MAGIC_LIST[n - 1]
                return spell_name
        print("å…¥åŠ›ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚")


# --- ã“ã“ã‹ã‚‰è¿½åŠ : ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§ã¨é¸æŠãƒ¡ãƒ‹ãƒ¥ãƒ¼ ---
def print_item_menu_grouped(
    item_list: List[str],                  # æ‰€æŒã‚¢ã‚¤ãƒ†ãƒ åãƒªã‚¹ãƒˆ
    items_by_name: Dict[str, Dict[str, Any]],
) -> List[str]:
    """
    item_list ã‚’ items_by_name ã®æƒ…å ±ã§åˆ†é¡ã—ã¦è¡¨ç¤ºã€‚
    æˆ»ã‚Šå€¤ï¼šè¡¨ç¤ºé †ã®ã‚¢ã‚¤ãƒ†ãƒ åãƒªã‚¹ãƒˆï¼ˆç•ªå·â†’åå‰å¯¾å¿œç”¨ï¼‰
    """

    anywhere_buckets = defaultdict(list)
    combat_buckets   = defaultdict(list)

    for name in item_list:
        item_json = items_by_name.get(name)
        if not item_json:
            continue

        loc = (item_json.get("Location") or "").strip()
        effect_text = ((item_json.get("SpellInfo") or {}).get("Effect") or "").strip()

        if loc.lower() == "anywhere":
            cat = categorize_anywhere_item(effect_text)
            anywhere_buckets[cat].append((name, qty))
        elif loc.lower() == "combat":
            cat = categorize_combat_item(effect_text)
            combat_buckets[cat].append((name, qty))
        else:
            cat = "Other"
            anywhere_buckets[cat].append((name, qty))

    anywhere_order = ["Restore", "Revive", "Cure", "Other"]
    combat_order   = ["Damage", "Inflict", "Support"]

    shown_names: List[str] = []
    idx = 1

    if any(anywhere_buckets.get(c) for c in anywhere_order):
        print("ã€Anywhereã€‘")
        for cat in anywhere_order:
            names = anywhere_buckets.get(cat, [])
            if not names:
                continue
            print(f"  {cat}:")
            for n in names:
                print(f"    {idx}: {n}")
                shown_names.append(n)
                idx += 1

    if any(combat_buckets.get(c) for c in combat_order):
        print("ã€Combatã€‘")
        for cat in combat_order:
            names = combat_buckets.get(cat, [])
            if not names:
                continue
            print(f"  {cat}:")
            for n in names:
                print(f"    {idx}: {n}")
                shown_names.append(n)
                idx += 1

    return shown_names


def categorize_anywhere_item(effect_text: str) -> str:
    e = effect_text.lower()
    if "revive from ko" in e:
        return "Revive"
    if "cure " in e:
        return "Cure"
    if "restore" in e:
        return "Restore"
    return "Other"


def categorize_combat_item(effect_text: str) -> str:
    e = effect_text.lower()
    if "deal" in e and "damage" in e:
        return "Damage"
    if "inflict " in e:
        return "Inflict"
    return "Support"


def build_grouped_item_menu(
    item_list: List[Tuple[str, str, int]],  # [(name, itype, qty), ...]
    items_by_name: Dict[str, Dict[str, Any]]
) -> List[str]:

    anywhere_buckets = defaultdict(list)  # {cat: [(name, qty), ...]}
    combat_buckets   = defaultdict(list)

    for name, itype, qty in item_list:
        item_json = items_by_name.get(name, {})
        spell_info = item_json.get("SpellInfo") or {}
        effect_text = (spell_info.get("Effect") or "")

        if itype.lower() == "anywhere":
            cat = categorize_anywhere_item(effect_text)
            anywhere_buckets[cat].append((name, qty))   # â˜…2è¦ç´ ã ã‘
        elif itype.lower() == "combat":
            cat = categorize_combat_item(effect_text)
            combat_buckets[cat].append((name, qty))     # â˜…2è¦ç´ ã ã‘
        else:
            anywhere_buckets["Other"].append((name, qty))  # â˜…2è¦ç´ ã ã‘

    anywhere_order = ["Restore", "Revive", "Cure", "Other"]
    combat_order   = ["Damage", "Inflict", "Support"]

    label_anywhere = {
        "Restore": "Restoreï¼ˆå›å¾©ï¼‰",
        "Revive": "Reviveï¼ˆè˜‡ç”Ÿï¼‰",
        "Cure": "Cureï¼ˆæ²»ç™‚ï¼‰",
        "Other": "Otherï¼ˆãã®ä»–ï¼‰",
    }
    label_combat = {
        "Damage": "Damageï¼ˆæ”»æ’ƒï¼‰",
        "Inflict": "Inflictï¼ˆçŠ¶æ…‹ç•°å¸¸ï¼‰",
        "Support": "Supportï¼ˆè£œåŠ©/ãã®ä»–ï¼‰",
    }

    # =========================================================
    # â˜… Damageï¼ˆæ”»æ’ƒï¼‰ã ã‘ã€Œå±æ€§â†’å¨åŠ›â†’åå‰ã€ã§ã‚½ãƒ¼ãƒˆ
    #    entries ã¯ (name, qty) ãªã®ã§ name ã¯ x[0]
    # =========================================================
    ELEMENT_ORDER = {
        "": 0, "none": 0, "-": 0,
        "ice": 1,
        "wind": 2,
        "lightning": 3, "thunder": 3,
        "earth": 4,
        "holy": 5,
        "dark": 6,
        "fire": 7,
    }

    def damage_sort_key(name: str):
        item_json = items_by_name.get(name, {})
        spell_info = item_json.get("SpellInfo") or {}

        elem_raw = spell_info.get("Element") or spell_info.get("Elements") or ""
        if isinstance(elem_raw, list):
            elem = (elem_raw[0] if elem_raw else "")
        else:
            elem = str(elem_raw)

        elem_l = elem.strip().lower()
        elem_rank = ELEMENT_ORDER.get(elem_l, 99)

        power = spell_info.get("BasePower")
        if power is None:
            power = item_json.get("Value", 0) or 0
        power = int(power)

        return (elem_rank, -power, name)

    if combat_buckets.get("Damage"):
        combat_buckets["Damage"].sort(key=lambda x: damage_sort_key(x[0]))  # â˜…x[0]=name

    shown_names: List[str] = []
    idx = 1

    def print_one_line(cat_label: str, entries: List[Tuple[str, int]]):
        nonlocal idx, shown_names
        if not entries:
            return
        parts = []
        for n, q in entries:
            parts.append(f"{idx}: {n}({q})")
            shown_names.append(n)
            idx += 1
        print(f"  {cat_label}: " + ", ".join(parts))

    if any(anywhere_buckets.get(c) for c in anywhere_order):
        print("ã€Anywhereã€‘")
        for cat in anywhere_order:
            entries = anywhere_buckets.get(cat, [])
            print_one_line(label_anywhere.get(cat, cat), entries)

    if any(combat_buckets.get(c) for c in combat_order):
        print("ã€Combatã€‘")
        for cat in combat_order:
            entries = combat_buckets.get(cat, [])
            print_one_line(label_combat.get(cat, cat), entries)

    return shown_names


def choose_item() -> str:
    """
    ITEM_LIST ã‹ã‚‰ç•ªå·ã§ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸ã°ã›ã¦ã€é¸ã°ã‚ŒãŸã€Œã‚¢ã‚¤ãƒ†ãƒ åã€ã‚’è¿”ã™ã€‚
    Effectåˆ†é¡ã¤ãè¡¨ç¤ºç‰ˆã€‚
    """
    if not ITEM_LIST:
        print("ä½¿ç”¨å¯èƒ½ãªã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“ã€‚")
        return ""

    print("ä½¿ç”¨ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚")
    menu_order = build_grouped_item_menu(ITEM_LIST, items_by_name)

    if not menu_order:
        print("ä½¿ç”¨å¯èƒ½ãªã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“ã€‚")
        return ""

    while True:
        s = input(f"ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (1-{len(menu_order)}): ").strip()
        if s.isdigit():
            n = int(s)
            if 1 <= n <= len(menu_order):
                return menu_order[n - 1]
        print("å…¥åŠ›ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚")


def is_out_of_battle(state: BattleActorState) -> bool:
    """ãã®ã‚­ãƒ£ãƒ©ãŒæˆ¦é—˜ã‹ã‚‰é›¢è„±ã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹"""
    return (
        state.hp <= 0
        or Status.KO in state.statuses
        or Status.PETRIFY in state.statuses
    )


def simulate_battle_once(
    char_name: str,
    enemy_name: str,
    char_stats: ff3_calc.FinalCharacterStats,
    enemy_stats: ff3_calc.FinalEnemyStats,
    enemy_json: dict,
    spells_by_name: dict | None = None,
    char_attack_kind: str = "physical",
    spell_name: str | None = None,
    max_turns: int = 100,
    rng: random.Random | None = None,
) -> tuple[str, int]:
    """
    1ãƒãƒˆãƒ«åˆ†ã‚’æœ€å¾Œã¾ã§ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ã¦çµæœã‚’è¿”ã™ã€‚
    """
    if rng is None:
        rng = random.Random()

    char_state = ff3_calc.BattleActorState(
        hp=char_stats.max_hp,
        max_hp=char_stats.max_hp,
    )
    enemy_state = ff3_calc.BattleActorState(
        hp=enemy_stats.hp,
        max_hp=enemy_stats.hp,
    )

    for turn in range(1, max_turns + 1):
        if char_attack_kind == "magic":
            if spells_by_name is None or spell_name is None:
                raise ValueError("magic æ”»æ’ƒã‚’ã™ã‚‹å ´åˆã¯ spells_by_name ã¨ spell_name ãŒå¿…è¦ã§ã™ã€‚")

            result = ff3_calc.simulate_one_turn_with_spell_name(
                char_name=char_name,
                enemy_name=enemy_name,
                char_stats=char_stats,
                enemy_stats=enemy_stats,
                enemy_json=enemy_json,
                char_state=char_state,
                enemy_state=enemy_state,
                spell_name=spell_name,
                spells_by_name=spells_by_name,
                job=job_data,
                rng=rng,
            )
        else:
            result = ff3_calc.simulate_one_turn(
                char_name=char_name,
                enemy_name=enemy_name,
                char_stats=char_stats,
                enemy_stats=enemy_stats,
                enemy_json=enemy_json,
                char_state=char_state,
                enemy_state=enemy_state,
                char_attack_kind="physical",
                char_weapon_hand="main",
                rng=rng,
            )

        char_state = result.char_state
        enemy_state = result.enemy_state

        char_out = is_out_of_battle(char_state)
        enemy_out = is_out_of_battle(enemy_state)

        if char_out and enemy_out:
            return "draw", turn
        elif enemy_out:
            return "char", turn
        elif char_out:
            return "enemy", turn

    return "draw", max_turns


def simulate_many_battles(
    n_trials: int,
    char_name: str,
    enemy_name: str,
    char_stats: ff3_calc.FinalCharacterStats,
    enemy_stats: ff3_calc.FinalEnemyStats,
    enemy_json: dict,
    spells_by_name: dict | None = None,
    char_attack_kind: str = "physical",
    spell_name: str | None = None,
    max_turns: int = 100,
    seed: int | None = None,
) -> dict:
    """
    åŒã˜æ¡ä»¶ã§ n_trials å›ãƒãƒˆãƒ«ã‚’è¡Œã„ã€å‹ç‡ã‚„å¹³å‡ã‚¿ãƒ¼ãƒ³æ•°ã‚’é›†è¨ˆã™ã‚‹ã€‚
    """
    rng = random.Random(seed)

    wins_char = 0
    wins_enemy = 0
    draws = 0
    turn_list: list[int] = []

    for _ in range(n_trials):
        winner, turns = simulate_battle_once(
            char_name=char_name,
            enemy_name=enemy_name,
            char_stats=char_stats,
            enemy_stats=enemy_stats,
            enemy_json=enemy_json,
            spells_by_name=spells_by_name,
            char_attack_kind=char_attack_kind,
            spell_name=spell_name,
            max_turns=max_turns,
            rng=rng,
        )
        turn_list.append(turns)

        if winner == "char":
            wins_char += 1
        elif winner == "enemy":
            wins_enemy += 1
        else:
            draws += 1

    total = n_trials
    win_rate_char = wins_char / total if total > 0 else 0.0
    win_rate_enemy = wins_enemy / total if total > 0 else 0.0
    draw_rate = draws / total if total > 0 else 0.0
    avg_turns = sum(turn_list) / len(turn_list) if turn_list else 0.0

    return {
        "trials": total,
        "wins_char": wins_char,
        "wins_enemy": wins_enemy,
        "draws": draws,
        "win_rate_char": win_rate_char,
        "win_rate_enemy": win_rate_enemy,
        "draw_rate": draw_rate,
        "average_turns": avg_turns,
    }

# =========================
# JSON èª­ã¿è¾¼ã¿
# =========================
monsters = load_monsters(Path("ffiii_monsters.json"))
weapons  = load_weapons(Path("ffiii_weapons.json"))
armors   = load_armors(Path("ffiii_armors.json"))
spells   = load_spells(Path("ffiii_spells.json"))
items_by_name = load_items(Path("ffiii_items.json"))
jobs_by_name  = ff3_calc.load_jobs(Path("ffiii_jobs_compact.json"))

with Path("ffiii_savedata.json").open(encoding="utf-8") as f:
    save = json.load(f)

# =========================
# ãƒ‘ãƒ¼ãƒ†ã‚£å…ˆé ­ã‚­ãƒ£ãƒ©ã‚’å–å¾—
# =========================
party_entry = save["party"][0]
job_name = party_entry["job"]
job_data = jobs_by_name[job_name]


# CastBy ã‚’ä½µç”¨ã—ãŸã„å ´åˆã® job â†’ code
JOB_CAST_CODE = {
    "Red Mage": "RM",
    "White Mage": "WM",
    "Black Mage": "BM",
    "Evoker": "Ev",
    "Devout": "De",
    "Magus": "Ma",
    "Summoner": "Su",
    "Sage": "Sa",
}

# =========================
# å¬å–šé­”æ³•ã®å­Spellsã‚’å±•é–‹ã—ãŸè¾æ›¸
# =========================
spells_expanded = expand_spells_for_summons(spells)

# ãã®ã‚¸ãƒ§ãƒ–ãŒä½¿ãˆã‚‹é­”æ³•å
allowed_names = allowed_spell_names_for_job(job_data)
cast_code = JOB_CAST_CODE.get(job_name)

# é­”æ³•ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ§‹ç¯‰ï¼ˆâ˜… allowed_names / cast_code ã¯ã“ã“ã§æ¸¡ã™ï¼‰
MAGIC_LIST = build_magic_list(
    spells_expanded,
    allowed_names=allowed_names,
    cast_code=cast_code,
)

# ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§ï¼ˆff3_calc ã« build_item_list ãŒã‚ã‚‹å ´åˆï¼‰
if build_item_list is None:
    print("â€» build_item_list ãŒ ff3_calc ã«ç„¡ã„ãŸã‚ ITEM_LIST ã¯ç©ºã§ã™ã€‚å¿…è¦ãªã‚‰è‡ªä½œã—ã¦ãã ã•ã„ã€‚")
    ITEM_LIST = []
else:
    # â˜… party_entryï¼ˆã‚­ãƒ£ãƒ©ã®æ‰€æŒå“ï¼‰ã‚’æ¸¡ã™å¿…è¦ãŒã‚ã‚‹ï¼
    ITEM_LIST: List[Tuple[str, str]] = build_item_list(items_by_name, save)


# =========================
# ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ â†’ ã‚­ãƒ£ãƒ©æœ€çµ‚ã‚¹ãƒ†
# =========================
base, eq, char_state = character_from_party_entry(party_entry, jobs_by_name)
char_final = compute_character_final_stats(base, eq, weapons, armors)

# =========================
# æ•µã®ä¾‹ï¼šåå‰ã§é¸ã¶ï¼ˆå¿…è¦ã«å¿œã˜ã¦å¤‰æ›´ï¼‰
# =========================
enemy_name = "Flyer"  # â†å¥½ããªæ•µåã«å¤‰ãˆã¦ãã ã•ã„
enemy_json = monsters[enemy_name]
enemy_final = compute_enemy_final_stats(enemy_json)

enemy_state = BattleActorState(
    hp=enemy_final.hp,
    max_hp=enemy_final.hp,
)

print(f"ã‚­ãƒ£ãƒ©: {party_entry['name']} / ã‚¸ãƒ§ãƒ–: {job_name}")
print(f"æ•µ: {enemy_name}")
print(f"é­”æ³•æ•°: {len(MAGIC_LIST)} / ã‚¢ã‚¤ãƒ†ãƒ æ•°: {len(ITEM_LIST)}")

rng = random.Random()

for turn in range(1, 11):

    # é›¢è„±ãƒã‚§ãƒƒã‚¯
    if is_out_of_battle(char_state):
        print("ãƒ«ãƒ¼ãƒã‚¹ã¯æˆ¦é—˜ä¸èƒ½çŠ¶æ…‹ã®ãŸã‚ã€æˆ¦é—˜ã‚’ç¶šè¡Œã§ãã¾ã›ã‚“ã€‚")
        break
    if is_out_of_battle(enemy_state):
        print(f"{enemy_json['name']}ã¯ã™ã§ã«æˆ¦é—˜ä¸èƒ½ã§ã™ã€‚")
        break

    # ã‚¿ãƒ¼ãƒ³é–‹å§‹è¡¨ç¤º
    print(
        f"--- Turn {turn} ---\n"
        + ff3_calc.format_state_line("ãƒ«ãƒ¼ãƒã‚¹", char_state)
        + " / "
        + ff3_calc.format_state_line(enemy_json["name"], enemy_state)
    )

    # â€»æ—§ã€Œ1/2/3ã§æ”»æ’ƒç¨®åˆ¥ã‚’é¸ã¶ã€UIã¯å»ƒæ­¢
    # print("æ”»æ’ƒæ–¹æ³•ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚")
    # print("  1: ç‰©ç†æ”»æ’ƒ")
    # print("  2: é­”æ³•æ”»æ’ƒ")
    # print("  3: ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½¿ã†")
    # mode = input("ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (1/2/3): ").strip()

    # --- ã‚¸ãƒ§ãƒ–ã®æˆ¦é—˜ã‚³ãƒãƒ³ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆJob.raw ã‹ã‚‰å–ã‚‹ï¼‰ ---
    commands = [
        job_data.raw[f"BattleCommand{i}"]["Command"]
        for i in range(1, 5)
        if job_data.raw.get(f"BattleCommand{i}")
    ]
    
    print("ä½¿ç”¨ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚")
    for idx, cmd in enumerate(commands, start=1):
        print(f"  {idx}: {cmd}")
    
    while True:
        s = input(f"ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (1-{len(commands)}): ").strip()
        if s.isdigit() and 1 <= int(s) <= len(commands):
            selected_command = commands[int(s) - 1]
            break
        print("å…¥åŠ›ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚")
    
    normalized_kind = ff3_calc.normalize_battle_command(selected_command)

    if not commands:
        commands = ["Fight", "Defend", "Item", "Run"]

# ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
    if normalized_kind == "physical":
        result_turn = ff3_calc.simulate_one_turn(
            char_name="ãƒ«ãƒ¼ãƒã‚¹",
            enemy_name=enemy_json["name"],
            char_stats=char_final,
            enemy_stats=enemy_final,
            enemy_json=enemy_json,
            char_state=char_state,
            enemy_state=enemy_state,
            char_battle_command=selected_command,
            rng=rng,
        )

    elif normalized_kind == "magic":
        spell_name = choose_magic(char_state)
        if not spell_name:
            print("é­”æ³•ãŒé¸æŠã•ã‚Œãªã‹ã£ãŸãŸã‚ã€ç‰©ç†æ”»æ’ƒã‚’è¡Œã„ã¾ã™ã€‚")
            result_turn = ff3_calc.simulate_one_turn(
                char_name="ãƒ«ãƒ¼ãƒã‚¹",
                enemy_name=enemy_json["name"],
                char_stats=char_final,
                enemy_stats=enemy_final,
                enemy_json=enemy_json,
                char_state=char_state,
                enemy_state=enemy_state,
                char_battle_command="Fight",
                rng=rng,
            )
        else:
            result_turn = ff3_calc.simulate_one_turn_with_spell_name(
                char_name="ãƒ«ãƒ¼ãƒã‚¹",
                enemy_name=enemy_json["name"],
                char_stats=char_final,
                enemy_stats=enemy_final,
                enemy_json=enemy_json,
                char_state=char_state,
                enemy_state=enemy_state,
                spell_name=spell_name,
                spells_by_name=spells_expanded,
                job=job_data,
                rng=rng,
            )

    elif normalized_kind == "item":
        ITEM_LIST = ff3_calc.build_item_list(items_by_name, save, in_battle=True)
        ITEM_LIST = [
            (name, itype, qty)
            for (name, itype, qty) in ITEM_LIST
            if is_item_visible_in_context(items_by_name.get(name, {}), in_combat=True)
        ]

        if not ITEM_LIST:
            print("ä½¿ç”¨å¯èƒ½ãªã‚¢ã‚¤ãƒ†ãƒ ãŒãªã„ãŸã‚ã€ç‰©ç†æ”»æ’ƒã‚’è¡Œã„ã¾ã™ã€‚")
            result_turn = ff3_calc.simulate_one_turn(
                char_name="ãƒ«ãƒ¼ãƒã‚¹",
                enemy_name=enemy_json["name"],
                char_stats=char_final,
                enemy_stats=enemy_final,
                enemy_json=enemy_json,
                char_state=char_state,
                enemy_state=enemy_state,
                char_battle_command="Fight",
                rng=rng,
            )
        else:
            item_name = choose_item()
            result_turn = ff3_calc.simulate_one_turn_with_item_name(
                char_name="ãƒ«ãƒ¼ãƒã‚¹",
                enemy_name=enemy_json["name"],
                char_stats=char_final,
                enemy_stats=enemy_final,
                enemy_json=enemy_json,
                char_state=char_state,
                enemy_state=enemy_state,
                item_name=item_name,
                items_by_name=items_by_name,
                rng=rng,
                save=save,
            )

    elif normalized_kind == "defend":
        result_turn = ff3_calc.simulate_one_turn(
            char_name="ãƒ«ãƒ¼ãƒã‚¹",
            enemy_name=enemy_json["name"],
            char_stats=char_final,
            enemy_stats=enemy_final,
            enemy_json=enemy_json,
            char_state=char_state,
            enemy_state=enemy_state,
            char_battle_command="Defend",
            rng=rng,
        )

    elif normalized_kind == "run":
        result_turn = ff3_calc.simulate_one_turn(
            char_name="ãƒ«ãƒ¼ãƒã‚¹",
            enemy_name=enemy_json["name"],
            char_stats=char_final,
            enemy_stats=enemy_final,
            enemy_json=enemy_json,
            char_state=char_state,
            enemy_state=enemy_state,
            char_battle_command="Run",
            rng=rng,
        )

    else:
        print(f"ã€Š{selected_command}ã€‹ã¯æœªå®Ÿè£…ã®ãŸã‚ã€ç‰©ç†æ”»æ’ƒã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚")
        result_turn = ff3_calc.simulate_one_turn(
            char_name="ãƒ«ãƒ¼ãƒã‚¹",
            enemy_name=enemy_json["name"],
            char_stats=char_final,
            enemy_stats=enemy_final,
            enemy_json=enemy_json,
            char_state=char_state,
            enemy_state=enemy_state,
            char_battle_command="Fight",
            rng=rng,
        )

    # ãƒ­ã‚°è¡¨ç¤º
    for line in result_turn.logs:
        print(line)

    # â˜…æˆ¦é—˜çµ‚äº†ç†ç”±ã®ä¸€èˆ¬åŒ–
    if result_turn.end_reason != "continue":
        if result_turn.end_reason == "escaped":
            print("æˆ¦é—˜ã‹ã‚‰é›¢è„±ã—ã¾ã—ãŸã€‚")
        elif result_turn.end_reason == "enemy_defeated":
            print(f"{enemy_json['name']}ã‚’å€’ã—ãŸï¼")
        elif result_turn.end_reason == "char_defeated":
            print("ãƒ«ãƒ¼ãƒã‚¹ã¯æˆ¦é—˜ä¸èƒ½ã«ãªã£ãŸâ€¦")
        elif result_turn.end_reason == "forced_end":
            print("ã‚¤ãƒ™ãƒ³ãƒˆã«ã‚ˆã‚Šæˆ¦é—˜ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚")
        break

    # çŠ¶æ…‹æ›´æ–°
    char_state = result_turn.char_state
    enemy_state = result_turn.enemy_state

    # ã‚¿ãƒ¼ãƒ³å¾Œã®é›¢è„±ãƒã‚§ãƒƒã‚¯
    if is_out_of_battle(char_state) or is_out_of_battle(enemy_state):
        break
